---

title: Torch Compatible Utilities


keywords: fastai
sidebar: home_sidebar

summary: "Torch Dataset and Dataloader compatible classes and functions for multi-core TPU training"
description: "Torch Dataset and Dataloader compatible classes and functions for multi-core TPU training"
nb_path: "nbs/03a_multi_core.torch_compat.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03a_multi_core.torch_compat.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/butchland/fastai_xla_extensions/blob/master/nbs/03a_multi_core.torch_compat.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TfmdTorchDS" class="doc_header"><code>class</code> <code>TfmdTorchDS</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L39" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TfmdTorchDS</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>A torch dataset compatible holder for items with x and y transforms</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="n">test_eq</span>
<span class="k">def</span> <span class="nf">neg_tfm</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">o</span>
<span class="k">def</span> <span class="nf">double_tfm</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">o</span>
<span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">TfmdTorchDS</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">x_tfm</span><span class="o">=</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">y_tfm</span><span class="o">=</span><span class="n">double_tfm</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ds1</span><span class="p">[</span><span class="mi">5</span><span class="p">],(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="to_list" class="doc_header"><code>to_list</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>to_list</code>(<strong><code>o</code></strong>)</p>
</blockquote>
<p>return item o as a list (unchanged if o is already a list and empty list if o is None)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="has_setup" class="doc_header"><code>has_setup</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L65" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>has_setup</code>(<strong><code>tfms</code></strong>)</p>
</blockquote>
<p>returns last index if at least 1 <code>tfm</code> in <code>tfms</code> has a method <code>setup</code> else return -1</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_setups" class="doc_header"><code>run_setups</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_setups</code>(<strong><code>tfms</code></strong>, <strong><code>items</code></strong>)</p>
</blockquote>
<p>run tfm setups including tfm for all items</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TorchDatasetBuilder" class="doc_header"><code>class</code> <code>TorchDatasetBuilder</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L84" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TorchDatasetBuilder</code>(<strong><code>source</code></strong>, <strong><code>get_items</code></strong>, <strong><code>splitter</code></strong>, <strong><code>x_tfms</code></strong>, <strong><code>y_tfms</code></strong>, <strong><code>x_type_tfms</code></strong>=<em><code>None</code></em>, <strong><code>x_train_tfms</code></strong>=<em><code>None</code></em>, <strong><code>x_test_tfms</code></strong>=<em><code>None</code></em>, <strong><code>do_setup</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>build torch compatible train and test datasets with transforms</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="VocabularyMapper" class="doc_header"><code>class</code> <code>VocabularyMapper</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L132" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>VocabularyMapper</code>(<strong><code>vocab</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>A simplified version of the fastai Categorize Transform</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torchvision</span> <span class="k">as</span> <span class="nn">thv</span>

<span class="n">pil2tensor</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="n">resize28</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">GrandparentSplitter</span><span class="p">,</span> <span class="n">parent_label</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="n">mnist_dset_builder</span> <span class="o">=</span>  <span class="n">TorchDatasetBuilder</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> 
                <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span> 
                <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(),</span>
                <span class="n">x_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">resize28</span><span class="p">,</span><span class="n">pil2tensor</span><span class="p">,</span><span class="n">norm</span><span class="p">,],</span> 
                <span class="n">y_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">parent_label</span><span class="p">,</span><span class="n">VocabularyMapper</span><span class="p">(),],</span>
                <span class="n">x_type_tfms</span><span class="o">=</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">train_ds</span><span class="p">,</span> <span class="n">test_ds</span> <span class="o">=</span> <span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">),</span><span class="mi">709</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_ds</span><span class="p">),</span><span class="mi">699</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">train_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">parent_label</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">train_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">norm</span><span class="p">(</span><span class="n">pil2tensor</span><span class="p">(</span><span class="n">resize28</span><span class="p">(</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])))))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.to" class="doc_header"><code>DataLoader.to</code><a href="__main__.py#L4" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DataLoader.to</code>(<strong><code>device</code></strong>)</p>
</blockquote>
<p>move torch dataloader to device (for compatibility with fastai dataloader)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_torch_dataloaders" class="doc_header"><code>make_torch_dataloaders</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L156" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_torch_dataloaders</code>(<strong><code>train_dataset</code></strong>, <strong><code>test_dataset</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>bs</code></strong>, <strong><code>num_workers</code></strong>=<em><code>4</code></em>, <strong><code>distrib</code></strong>=<em><code>True</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>make torch-based distributed dataloaders from torch compatible datasets</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FileNamePatternLabeller" class="doc_header"><code>class</code> <code>FileNamePatternLabeller</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/torch_compat.py#L222" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FileNamePatternLabeller</code>(<strong><code>pat_str</code></strong>, <strong><code>match</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Delayed action version of fastai RegexLabeller with file name selection</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-Model-Training-using-Torch-Dataloaders">Test Model Training using Torch Dataloaders<a class="anchor-link" href="#Test-Model-Training-using-Torch-Dataloaders"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai_xla_extensions.multi_core.base</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai_xla_extensions.misc_utils</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># patch _BaseOptimizer.__get_state__ and __setstate__</span>
<span class="kn">from</span> <span class="nn">my_timesaver_utils.profiling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">my_timesaver_utils.profiling_callback</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span>
<span class="kn">from</span> <span class="nn">fastai.metrics</span> <span class="kn">import</span> <span class="n">accuracy</span>

<span class="k">def</span> <span class="nf">train_torch_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_torch_model&#39;</span><span class="p">)</span>
    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">IS_PROFILING</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span>
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>

    <span class="c1"># Get loss function, optimizer, and model</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dset_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name2</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dataloader_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="n">make_torch_dataloaders</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">,</span> 
                                  <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> 
                                  <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> 
                                  <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                                  <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
                                  <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">,</span>
                                 <span class="p">)</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span>
                      <span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_multi_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">to_my_profile</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name3</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_run_fit&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">my_profile</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start training processes</span>
<span class="k">def</span> <span class="nf">_mp_fn2</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_torch_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastcore.transform</span> <span class="kn">import</span> <span class="n">DisplayedTransform</span><span class="p">,</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">store_attr</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span><span class="p">,</span> <span class="n">PILBase</span><span class="p">,</span> <span class="n">image2tensor</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">TransformBlock</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_c</span>
<span class="c1"># from fastai.vision.all import *</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">DataBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span>
<span class="kn">from</span> <span class="nn">fastai.vision.data</span> <span class="kn">import</span> <span class="n">ImageBlock</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">parent_label</span><span class="p">,</span> <span class="n">GrandparentSplitter</span>
<span class="kn">from</span> <span class="nn">fastai.vision.augment</span> <span class="kn">import</span> <span class="n">Resize</span><span class="p">,</span> <span class="n">aug_transforms</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">imagenet_stats</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="n">LOSS_FUNC</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="n">OPT_FUNC</span> <span class="o">=</span> <span class="n">Adam</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RandomSplitter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.learner</span> <span class="kn">import</span> <span class="n">create_cnn_model</span>
<span class="kn">from</span> <span class="nn">fastai.vision.models</span> <span class="kn">import</span> <span class="n">resnet34</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Define Parameters</span>
<span class="n">FLAGS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># FLAGS[&#39;batch_size&#39;] = 1024</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2e-3</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TPU_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>

<span class="c1"># FLAGS[&#39;num_cores&#39;] = 1 </span>
<span class="n">ARCH</span> <span class="o">=</span> <span class="n">resnet34</span>
<span class="n">USE_DBLOCK</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">fastcore.xtras</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
<span class="c1"># PATH = untar_data(URLs.MNIST)</span>
<span class="c1"># PATH = untar_data(URLs.MNIST_TINY)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">imagenet_norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
    <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> 
    <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>

<span class="n">cifar_norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
    <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> 
    <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">))</span>

<span class="n">image_size</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(.+)_\d+.jpg$&#39;</span>
<span class="n">fname_labeller</span> <span class="o">=</span> <span class="n">FileNamePatternLabeller</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>

<span class="n">DSET_BUILDER</span> <span class="o">=</span> <span class="n">TorchDatasetBuilder</span><span class="p">(</span>
    <span class="n">PATH</span><span class="p">,</span> 
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
    <span class="n">x_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">image_size</span><span class="p">,</span><span class="n">image_size</span><span class="p">)),</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">imagenet_norm</span><span class="p">],</span>
    <span class="n">y_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">fname_labeller</span><span class="p">,</span> <span class="n">VocabularyMapper</span><span class="p">(),],</span>
    <span class="n">x_type_tfms</span><span class="o">=</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
<span class="p">)</span> 
<span class="n">start_record</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
<span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">PATH</span><span class="p">),</span><span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">end_record</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
<span class="n">print_prof_data</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
<span class="n">clear_prof_data</span><span class="p">()</span>
<span class="n">N_OUT</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>     
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Function master_vocab_setup called 1 times.
Execution time max: 0.055, average: 0.055
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">N_OUT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">N_OUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;N_OUT </span><span class="si">{</span><span class="n">N_OUT</span><span class="si">}</span><span class="s1"> should be &gt; 0&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_model</span> <span class="o">=</span> <span class="n">create_cnn_model</span><span class="p">(</span><span class="n">ARCH</span><span class="p">,</span> <span class="n">N_OUT</span><span class="p">,</span> 
                                <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">concat_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading: &#34;https://download.pytorch.org/models/resnet34-333f7ec4.pth&#34; to /root/.cache/torch/hub/checkpoints/resnet34-333f7ec4.pth
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Only instantiate model weights once in memory.</span>
<span class="n">WRAPPED_MODEL</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">custom_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># !rm -f /content/models/stage-1.pth</span>
<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
        <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>build learner
start running fit
start fit
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.790961</td>
      <td>1.388766</td>
      <td>0.628906</td>
      <td>01:28</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.661789</td>
      <td>1.147588</td>
      <td>0.726562</td>
      <td>01:19</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.602246</td>
      <td>0.583778</td>
      <td>0.830078</td>
      <td>01:21</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.505505</td>
      <td>0.392288</td>
      <td>0.873047</td>
      <td>01:22</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.421940</td>
      <td>0.340927</td>
      <td>0.892578</td>
      <td>01:25</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 112 ms, sys: 131 ms, total: 243 ms
Wall time: 8min 2s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mdsets</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">()</span>
<span class="n">mdls</span> <span class="o">=</span> <span class="n">make_torch_dataloaders</span><span class="p">(</span><span class="o">*</span><span class="n">mdsets</span><span class="p">,</span>
                                <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">world_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">bs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span>
                                <span class="n">num_workers</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span>
                                <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">mdls</span><span class="p">,</span> <span class="n">custom_model</span><span class="p">,</span> 
                    <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                    <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                    <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                    <span class="n">wd</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">],</span>
                    <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]))</span>
<span class="n">mlearner</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">one_param</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">mlearner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cpu&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">valid_metrics</span> <span class="o">=</span> <span class="n">mlearner</span><span class="o">.</span><span class="n">validate</span><span class="p">();</span><span class="nb">print</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.2993701994419098, 0.901494562625885]
CPU times: user 3min 30s, sys: 3.18 s, total: 3min 33s
Wall time: 3min 38s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

