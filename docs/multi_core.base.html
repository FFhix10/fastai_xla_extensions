---

title: Multi Core XLA Base 


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/03_multi_core.base.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_multi_core.base.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://colab.research.google.com/github/butchland/fastai_xla_extensions/blob/master/nbs/03_multi_core.base.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Base module for Multi TPU Core implementation</p>
</blockquote>
<p>Multi-core TPU implementation is enabled by importing this module.</p>

<pre><code>from fastai_xla_extensions.multi_core.base import *</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utility-Conversion-Functions">Utility Conversion Functions<a class="anchor-link" href="#Utility-Conversion-Functions"> </a></h2><p>Functions for converting tensors and computing batches across ranks</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="revert_tensor" class="doc_header"><code>revert_tensor</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L44" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>revert_tensor</code>(<strong><code>o</code></strong>)</p>
</blockquote>
<p>Remove tensor subclass and revert to <code>torch.Tensor</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="recast2tensor" class="doc_header"><code>recast2tensor</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>recast2tensor</code>(<strong><code>o</code></strong>)</p>
</blockquote>
<p>Recast <code>fastai.torch_core.TensorBase</code> subclassed tensors to torch.Tensors</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="round_to_multiple" class="doc_header"><code>round_to_multiple</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L62" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>round_to_multiple</code>(<strong><code>number</code></strong>, <strong><code>multiple</code></strong>)</p>
</blockquote>
<p>round up batch samples to fill number of cores</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TPUDistributedDL" class="doc_header"><code>class</code> <code>TPUDistributedDL</code><a href="" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TPUDistributedDL</code>(<strong><code>dl</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>seed</code></strong>=<em><code>42</code></em>) :: <code>TfmdDL</code></p>
</blockquote>
<p>A <code>TfmdDL</code> which splits a batch into equal size pieces for each TPU core
It also recasts the output of a batch from a TensorBase subclass to
a regular tensor since the XLA Parallel loader doesn't seem to be compatible
to it.
Code implementation was based on @tmabraham's <a href="/fastai_xla_extensions/multi_core.base.html#TPUDistributedDL"><code>TPUDistributedDL</code></a> implementation
here: <a href="https://github.com/tmabraham/fastai_tpu/blob/master/fastai_v2/tpu_distributed_dl.py">https://github.com/tmabraham/fastai_tpu/blob/master/fastai_v2/tpu_distributed_dl.py</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">TensorBase</span><span class="p">,</span> <span class="n">TensorImage</span><span class="p">,</span> <span class="n">TensorCategory</span>
<span class="kn">from</span> <span class="nn">fastai.data.core</span> <span class="kn">import</span> <span class="n">TfmdDL</span>

<span class="n">n_batches</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">world_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1"># setup a dataloader as base dl for tpu </span>
<span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TensorImage</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()),</span> <span class="n">TensorCategory</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span> <span class="o">*</span> <span class="n">bs</span> <span class="o">*</span> <span class="n">world_size</span><span class="p">)]</span>
<span class="n">dl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_batches</span> <span class="o">*</span> <span class="n">world_size</span>
<span class="n">b0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dl</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TensorImage</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TensorCategory</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tpu_dl</span> <span class="o">=</span> <span class="n">TPUDistributedDL</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
<span class="c1"># the batches for dl for each rank is divided across all ranks</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpu_dl</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_batches</span>
<span class="n">tpu_b0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">tpu_dl</span><span class="p">))</span>
<span class="c1"># the types of each batch (x,y) have been reverted to torch tensors</span>
<span class="c1"># and are no longer Tensor subclasses (e.g. TensorBase)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpu_b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpu_b0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpu_b0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TensorBase</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpu_b0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TensorBase</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># add tests to make sure all items are retrieved per epoch</span>
<span class="c1"># create dl for each rank across all ranks</span>
<span class="n">tpu_dls</span> <span class="o">=</span> <span class="p">[</span><span class="n">TPUDistributedDL</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>
<span class="n">rank_batches</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">tpu_dl</span><span class="p">)</span> <span class="k">for</span> <span class="n">tpu_dl</span> <span class="ow">in</span> <span class="n">tpu_dls</span><span class="p">]</span>
<span class="c1"># TODO: check that each rank dont contain common items</span>
<span class="c1"># TODO: check that all items in dl are accounted for in the tpu_dls across all ranks</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Torch-Dataloader-Patches">Torch Dataloader Patches<a class="anchor-link" href="#Torch-Dataloader-Patches"> </a></h2><p>These patches to the torch dataloader make torch dataloaders
more compatible with fastai dataloaders (enabling them to run
inside the fastai Learners and use fastai training calls)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.__setattr__" class="doc_header"><code>DataLoader.__setattr__</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L170" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DataLoader.__setattr__</code>(<strong><code>attr</code></strong>, <strong><code>val</code></strong>)</p>
</blockquote>
<p>remove sampler,batch_sampler from list of attrs which should not be set after init</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.after_batch" class="doc_header"><code>DataLoader.after_batch</code><a href="" class="source_link" style="float:right">[source]</a></h4><p>return empty pipeline when fastai learner looks for after_batch</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.bs" class="doc_header"><code>DataLoader.bs</code><a href="" class="source_link" style="float:right">[source]</a></h4><p>return fastai synonym for torch batch size</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.device" class="doc_header"><code>DataLoader.device</code><a href="" class="source_link" style="float:right">[source]</a></h4><p>return null device</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.to" class="doc_header"><code>DataLoader.to</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L196" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DataLoader.to</code>(<strong><code>device</code></strong>)</p>
</blockquote>
<p>add impl for to(device)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataLoader.set_distributed_sampler" class="doc_header"><code>DataLoader.set_distributed_sampler</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L202" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DataLoader.set_distributed_sampler</code>(<strong><code>rank</code></strong>, <strong><code>world_size</code></strong>)</p>
</blockquote>
<p>replace sampler with torch distributed sampler</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Component-Functions-for-Multi-Core-TPU-Training">Component Functions for Multi Core TPU Training<a class="anchor-link" href="#Component-Functions-for-Multi-Core-TPU-Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="build_distributed_dataloaders" class="doc_header"><code>build_distributed_dataloaders</code><a href="__main__.py#L4" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>build_distributed_dataloaders</code>(<strong><code>dls</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Wrap dataloaders with distributed TPU aware dataloader</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_fastai_dataloaders" class="doc_header"><code>make_fastai_dataloaders</code><a href="__main__.py#L5" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_fastai_dataloaders</code>(<strong><code>datablock</code></strong>, <strong><code>source</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>create fastai-based dataloaders from a datablock and wrap a tpu distributed dataloader around them</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="wrap_parallel_loader" class="doc_header"><code>wrap_parallel_loader</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L250" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>wrap_parallel_loader</code>(<strong><code>loader</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>
<p>wraps a tpu distributed loader or a torch dataloader (with distributed sampler) with xla parallel loader</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLATrainingCallback" class="doc_header"><code>class</code> <code>XLATrainingCallback</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L264" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLATrainingCallback</code>(<strong><code>device</code></strong>, <strong><code>rank</code></strong>=<em><code>0</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>A callback for training as a spawned process on multi-core TPUs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/fastai_xla_extensions/multi_core.base.html#XLATrainingCallback"><code>XLATrainingCallback</code></a> is responsible for the following functions:</p>
<ul>
<li><p>sets the <code>epoch</code> on either the torch dataloader sampler or the TPU distributed DL before each epoch. This ensures that for each epoch, samples in each batch are the same across all ranks, but each rank will pick the subset of batches for each rank.</p>
<p>The <a href="/fastai_xla_extensions/multi_core.base.html#TPUDistributedDL"><code>TPUDistributedDL</code></a> (and the torch distributed sampler) ensures that all the samples (with some duplication if the samples are not exactly divisible by the number of ranks) are seen by one of the dataloaders across the ranks least once per epoch.</p>
</li>
<li>wraps the dataloader (either training or validation) with the XLA Parallel Loader (<code>torch_xla.distributed.parallel_loader.ParallelLoader</code>) before each training or validation run.</li>
<li>sidesteps the call to <code>opt.step</code> and instead calls <code>xm.optimizer_step(opt)</code> to sync the model gradients across all the ranks.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helper-Functions-for--SyncRecorderCallback">Helper Functions for  <a href="/fastai_xla_extensions/multi_core.base.html#SyncRecorderCallback"><code>SyncRecorderCallback</code></a><a class="anchor-link" href="#Helper-Functions-for--SyncRecorderCallback"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pack_metric" class="doc_header"><code>pack_metric</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L321" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pack_metric</code>(<strong><code>metrics</code></strong>)</p>
</blockquote>
<p>extract counts and totals from avg metrics and avg losses into a list</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_tensor" class="doc_header"><code>make_tensor</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L328" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_tensor</code>(<strong><code>o</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>
<p>convert a scalar or tensor into a float tensor and move them to <code>device</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pack_metrics" class="doc_header"><code>pack_metrics</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L334" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pack_metrics</code>(<strong><code>all_metrics</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>
<p>pack train and valid metrics into a list of float tensors and move them to <code>device</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="restore_metrics" class="doc_header"><code>restore_metrics</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L339" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>restore_metrics</code>(<strong><code>reduced_metrics</code></strong>, <strong><code>all_metrics</code></strong>)</p>
</blockquote>
<p>restore list of float tensors (count and values) back into train and valid metrics</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SyncRecorderCallback" class="doc_header"><code>class</code> <code>SyncRecorderCallback</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L360" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SyncRecorderCallback</code>(<strong><code>after_create</code></strong>=<em><code>None</code></em>, <strong><code>before_fit</code></strong>=<em><code>None</code></em>, <strong><code>before_epoch</code></strong>=<em><code>None</code></em>, <strong><code>before_train</code></strong>=<em><code>None</code></em>, <strong><code>before_batch</code></strong>=<em><code>None</code></em>, <strong><code>after_pred</code></strong>=<em><code>None</code></em>, <strong><code>after_loss</code></strong>=<em><code>None</code></em>, <strong><code>before_backward</code></strong>=<em><code>None</code></em>, <strong><code>before_step</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_step</code></strong>=<em><code>None</code></em>, <strong><code>after_step</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_batch</code></strong>=<em><code>None</code></em>, <strong><code>after_batch</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_train</code></strong>=<em><code>None</code></em>, <strong><code>after_train</code></strong>=<em><code>None</code></em>, <strong><code>before_validate</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_validate</code></strong>=<em><code>None</code></em>, <strong><code>after_validate</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_epoch</code></strong>=<em><code>None</code></em>, <strong><code>after_epoch</code></strong>=<em><code>None</code></em>, <strong><code>after_cancel_fit</code></strong>=<em><code>None</code></em>, <strong><code>after_fit</code></strong>=<em><code>None</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>A <code>Callback</code> to sync the metrics from each rank and update statistics
accordingly so it will display correctly in the progress callback</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Learner-Patches-and-Helper-Functions-for-Multi-Core-TPU-Extensions">Learner Patches and Helper Functions for Multi Core TPU Extensions<a class="anchor-link" href="#Learner-Patches-and-Helper-Functions-for-Multi-Core-TPU-Extensions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="xm_save" class="doc_header"><code>xm_save</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L441" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>xm_save</code>(<strong><code>data</code></strong>, <strong><code>file_or_path</code></strong>, <strong><code>master_only</code></strong>=<em><code>True</code></em>, <strong><code>global_master</code></strong>=<em><code>False</code></em>, <strong><code>rendezvous</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Saves the input data into a file.</p>
<p>The saved data is transferred to PyTorch CPU device before being saved, so a
following <code>torch.load()</code> will load CPU data.
Care must be taken when working with views. Instead of saving views it's
recommended that you recreate them after the tensors have been loaded and
moved to their destination device(s).</p>
<p>Args:
data: The input data to be saved. Any nested combination of Python objects
    (list, tuples, sets, dicts, ...).
file_or_path: The destination for the data saving operation. Either a file
    path or a Python file object. If <code>master_only</code> is <code>False</code> the path or
    file objects must point to different destinations as otherwise all the
    writes from the same host will override each other.
master_only (bool, optional): Whether only the master device should save the
    data. If False, the <code>file_or_path</code> argument should be a different file or
    path for each of the ordinals taking part to the replication, otherwise
    all the replicas on the same host will be writing to the same location.
    Default: True
global_master (bool, optional): When <code>master_only</code> is <code>True</code> this flag
    controls whether every host's master (if <code>global_master</code> is <code>False</code>)
    saves the content, or only the global master (ordinal 0).
    Default: False</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="SaveModelCallback._save" class="doc_header"><code>SaveModelCallback._save</code><a href="__main__.py#L4" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>SaveModelCallback._save</code>(<strong><code>name</code></strong>)</p>
</blockquote>
<p>save best model using <code>rendezvous=False</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.save" class="doc_header"><code>Learner.save</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L490" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.save</code>(<strong><code>file</code></strong>, <strong><code>with_opt</code></strong>=<em><code>True</code></em>, <strong><code>pickle_protocol</code></strong>=<em><code>2</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/fastai_xla_extensions/multi_core.base.html#Learner.save"><code>Learner.save</code></a> has been patched to use the torch xla method <code>xm.save</code> which will save the model weights for the model on the TPU device. Moreover, <code>xm.save</code> only saves the weights on the master ordinal rank process by default, ensuring that only one copy of the model is written to a file. _Which is fine, since the <code>xm.optimizer_step</code> done on each training batch synchronizes the weights across all ranks anyway._</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.to_multi_xla" class="doc_header"><code>Learner.to_multi_xla</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L510" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.to_multi_xla</code>(<strong><code>device</code></strong>, <strong><code>rank</code></strong>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Sets up the learner on the spawned process for multi core TPU training</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_one_loop" class="doc_header"><code>do_one_loop</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core/base.py#L538" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_one_loop</code>(<strong><code>dl</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>device</code></strong>, <strong><code>wrap_parallel</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>test one loop for a tpu distributed dataloader</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-out-the-code">Test out the code<a class="anchor-link" href="#Test-out-the-code"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_dataloader_loop</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> start run_dataloader_loop&#39;</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_run_dataloader_loop&#39;</span><span class="p">)</span>
    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>
    <span class="n">IS_PROFILING</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span>
    <span class="c1"># Get loss function, optimizer, and model</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dataloader_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>

    <span class="c1"># dls = make_fastai_dataloaders(</span>
    <span class="c1">#                         DATA, </span>
    <span class="c1">#                         PATH, </span>
    <span class="c1">#                         rank=rank, </span>
    <span class="c1">#                         world_size=world_size, </span>
    <span class="c1">#                         sync_valid=SYNC_VALID,</span>
    <span class="c1">#                         bs=bs,)</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="n">DATA</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
    <span class="c1"># distrib_dls = build_distributed_dataloaders(dls, rank, world_size, </span>
    <span class="c1">#                                            sync_valid=True)</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">train</span>
    <span class="n">tpu_dl</span> <span class="o">=</span> <span class="n">TPUDistributedDL</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span><span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla: </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> fake_l.num_workers </span><span class="si">{</span><span class="n">tpu_dl</span><span class="o">.</span><span class="n">fake_l</span><span class="o">.</span><span class="n">num_workers</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">do_one_loop</span><span class="p">(</span><span class="n">tpu_dl</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">wrap_parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> completed run_dataloader_loop&#39;</span><span class="p">)</span>
    <span class="c1"># print_prof_data()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_model&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> start train model&#39;</span><span class="p">)</span>

    
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>
    <span class="n">IS_PROFILING</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span>
    <span class="c1"># Get loss function, optimizer, and model</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dataloader_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">make_fastai_dataloaders</span><span class="p">(</span>
                            <span class="n">DATA</span><span class="p">,</span> 
                            <span class="n">PATH</span><span class="p">,</span> 
                            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> 
                            <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> 
                            <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span><span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_multi_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">to_my_profile</span><span class="p">()</span>

    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name3</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_run_fit&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;end_train_model&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">,</span> <span class="n">rendezvous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">IS_PROFILING</span> <span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">my_profile</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>

    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_mnist_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_mnist_model&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> start train mnist model&#39;</span><span class="p">)</span>    
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">make_fastai_dataloaders</span><span class="p">(</span>
                            <span class="n">DATA2</span><span class="p">,</span> 
                            <span class="n">PATH2</span><span class="p">,</span> 
                            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> 
                            <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> 
                            <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span><span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_multi_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;end_train_mnist_model&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;mnist-stage-1&#39;</span><span class="p">,</span> <span class="n">rendezvous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>  
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the main method that runs the training.</p>
<p>It includes some profiling code to measure the building of the <code>dataloaders</code> and running of the <code>fit</code> methods.</p>
<p>At the end of the spawned processes, the master ordinal process saves the model to a temporary file. (see <a href="/fastai_xla_extensions/multi_core.base.html#Learner.save"><code>Learner.save</code></a> patch above)</p>
<p>The saved model will then be loaded by the main process so that it will now contain the trained weights updated by the spawned training processes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start training processes</span>
<span class="k">def</span> <span class="nf">_mp_fn</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start dataloader processes</span>
<span class="k">def</span> <span class="nf">_mp_fn2</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">run_dataloader_loop</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start training processes</span>
<span class="k">def</span> <span class="nf">_mp_fn3</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS2</span>
    <span class="n">FLAGS2</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_mnist_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastcore.transform</span> <span class="kn">import</span> <span class="n">DisplayedTransform</span><span class="p">,</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">store_attr</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span><span class="p">,</span> <span class="n">PILBase</span><span class="p">,</span> <span class="n">image2tensor</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">TransformBlock</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_c</span>
<span class="c1"># from fastai.vision.all import *</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">DataBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span>
<span class="kn">from</span> <span class="nn">fastai.vision.data</span> <span class="kn">import</span> <span class="n">ImageBlock</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">parent_label</span><span class="p">,</span> <span class="n">GrandparentSplitter</span>
<span class="kn">from</span> <span class="nn">fastai.vision.augment</span> <span class="kn">import</span> <span class="n">Resize</span><span class="p">,</span> <span class="n">aug_transforms</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">imagenet_stats</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">using_attr</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RegexLabeller</span><span class="p">,</span> <span class="n">CategoryMap</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="n">LOSS_FUNC</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="n">OPT_FUNC</span> <span class="o">=</span> <span class="n">Adam</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RandomSplitter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.learner</span> <span class="kn">import</span> <span class="n">create_cnn_model</span>
<span class="kn">from</span> <span class="nn">fastai.vision.models</span> <span class="kn">import</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">resnet18</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Define Parameters</span>
<span class="n">FLAGS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># FLAGS[&#39;batch_size&#39;] = 1024</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2e-3</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TPU_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
<span class="c1"># FLAGS[&#39;num_cores&#39;] = 1 </span>
<span class="n">ARCH</span> <span class="o">=</span> <span class="n">resnet34</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Define Parameters</span>
<span class="n">FLAGS2</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># FLAGS2[&#39;batch_size&#39;] = 64</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2e-3</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TPU_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
<span class="c1"># FLAGS[&#39;num_cores&#39;] = 1 </span>
<span class="n">ARCH2</span> <span class="o">=</span> <span class="n">resnet18</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">fastcore.xtras</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.xla_multiprocessing</span> <span class="k">as</span> <span class="nn">xmp</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
<span class="n">PATH2</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST</span><span class="p">)</span>
<span class="c1"># PATH = untar_data(URLs.MNIST_TINY)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(.+)_\d+.jpg$&#39;</span>
<span class="n">fname_labeller</span> <span class="o">=</span> <span class="n">using_attr</span><span class="p">(</span><span class="n">RegexLabeller</span><span class="p">(</span><span class="n">pat</span><span class="p">),</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> 
<span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span><span class="p">),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">fname_labeller</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Resize</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]),],</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fname_labeller</span><span class="p">))</span>
<span class="n">N_OUT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DATA2</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span><span class="p">),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(</span><span class="n">train_name</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span><span class="n">valid_name</span><span class="o">=</span><span class="s1">&#39;testing&#39;</span><span class="p">),</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Resize</span><span class="p">(</span><span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]),],</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">vocab2</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">PATH2</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parent_label</span><span class="p">))</span>
<span class="n">N_OUT2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">N_OUT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">N_OUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;N_OUT </span><span class="si">{</span><span class="n">N_OUT</span><span class="si">}</span><span class="s1"> should be &gt; 0&#39;</span>
<span class="k">assert</span> <span class="n">N_OUT2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">N_OUT2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;N_OUT2 </span><span class="si">{</span><span class="n">N_OUT2</span><span class="si">}</span><span class="s1"> should be &gt; 0&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model is created by the main process and wrapped by the <code>xmp.MpModelWrapper</code>. This is to reduce the memory usage by not having multiple copies of the model in the spawned processes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_model</span> <span class="o">=</span> <span class="n">create_cnn_model</span><span class="p">(</span><span class="n">ARCH</span><span class="p">,</span> <span class="n">N_OUT</span><span class="p">,</span> 
                                <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">concat_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_model2</span> <span class="o">=</span> <span class="n">create_cnn_model</span><span class="p">(</span><span class="n">ARCH2</span><span class="p">,</span> <span class="n">N_OUT2</span><span class="p">,</span> 
                                <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">concat_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Only instantiate model weights once in memory.</span>
<span class="n">WRAPPED_MODEL</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">custom_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">WRAPPED_MODEL2</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">custom_model2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="o">%%time</span>
<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
        <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
        <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>xla 7 start train model
xla 0 start train model
xla 2 start train model
xla 6 start train model
xla 5 start train model
xla 3 start train model
xla 4 start train model
xla 1 start train model
build learner
start running fit
start fit
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.731888</td>
      <td>1.632641</td>
      <td>0.588513</td>
      <td>01:41</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.626176</td>
      <td>1.512239</td>
      <td>0.616216</td>
      <td>01:24</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.569840</td>
      <td>0.564395</td>
      <td>0.853378</td>
      <td>01:24</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.496084</td>
      <td>0.326885</td>
      <td>0.906757</td>
      <td>01:22</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.420364</td>
      <td>0.289561</td>
      <td>0.914189</td>
      <td>01:22</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 138 ms, sys: 148 ms, total: 286 ms
Wall time: 7min 53s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># %%time</span>
<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn3</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS2</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS2</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
        <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>xla 7 start train mnist model
xla 5 start train mnist model
xla 0 start train mnist model
xla 6 start train mnist model
xla 3 start train mnist model
xla 2 start train mnist model
xla 4 start train mnist model
xla 1 start train mnist model
build learner
start running fit
start fit
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.482093</td>
      <td>1.195742</td>
      <td>0.610300</td>
      <td>01:42</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.328450</td>
      <td>0.487590</td>
      <td>0.890700</td>
      <td>01:46</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.283434</td>
      <td>0.106411</td>
      <td>0.972900</td>
      <td>01:46</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.251563</td>
      <td>0.052187</td>
      <td>0.985800</td>
      <td>01:47</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.223426</td>
      <td>0.042579</td>
      <td>0.988200</td>
      <td>02:03</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mdls</span> <span class="o">=</span> <span class="n">DATA</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">mdls</span><span class="p">,</span> <span class="n">custom_model</span><span class="p">,</span> 
                    <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                    <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                    <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                    <span class="n">wd</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">],</span>
                    <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]))</span>
<span class="c1"># load trained weights from multi core tpu training</span>
<span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;models/stage-1.pth&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
    <span class="n">mlearner</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cpu&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">one_param</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">mlearner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cpu&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">valid_metrics</span> <span class="o">=</span> <span class="n">mlearner</span><span class="o">.</span><span class="n">validate</span><span class="p">();</span><span class="nb">print</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.284559428691864, 0.9113667011260986]
CPU times: user 3min 37s, sys: 3.25 s, total: 3min 41s
Wall time: 3min 43s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">FLAGS3</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">64</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/content/data/cifar&#39;</span><span class="p">)</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2e-3</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TPU_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
<span class="c1"># FLAGS[&#39;num_cores&#39;] = 1 </span>
<span class="n">ARCH3</span> <span class="o">=</span> <span class="n">resnet18</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_dataset</span><span class="p">():</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
        <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">))</span>
    <span class="n">transform_train</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">norm</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">transform_test</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">],</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">])),</span>                                 
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">norm</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span>
        <span class="n">root</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">],</span>
        <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform_train</span><span class="p">)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span>
        <span class="n">root</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">],</span>
        <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform_test</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">get_dataset</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Files already downloaded and verified
Files already downloaded and verified
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span>
<span class="c1">#   sampler=train_sampler,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">],</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">],</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fastai dls using torch dataloaders</span>
<span class="n">CIFAR_DLS</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">N_OUT3</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># cifar10 has 10 labels</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_model3</span> <span class="o">=</span> <span class="n">create_cnn_model</span><span class="p">(</span><span class="n">ARCH3</span><span class="p">,</span> <span class="n">N_OUT3</span><span class="p">,</span> 
                                <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">concat_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">WRAPPED_MODEL3</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">custom_model3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">PrintDevicesCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span> <span class="c1"># before XLATrainingCallback</span>
    <span class="k">def</span> <span class="nf">before_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_device</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">before_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_device</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">print_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;train: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">training</span><span class="si">}</span><span class="s1"> xla </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">xla_rank</span><span class="si">}</span><span class="s1">: dl.type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">dl</span><span class="p">)</span><span class="si">}</span><span class="s1"> dl.device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1"> model.device: </span><span class="si">{</span><span class="n">one_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_cifar_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_cifar_model&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> start train cifar model&#39;</span><span class="p">)</span>    
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">build_distributed_dataloaders</span><span class="p">(</span><span class="n">CIFAR_DLS</span><span class="p">,</span> 
                                        <span class="n">rank</span><span class="p">,</span> 
                                        <span class="n">world_size</span><span class="p">,</span> 
                                        <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span> 
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL3</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span><span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_multi_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
    <span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrintDevicesCallback</span><span class="p">()]</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;end_train_cifar_model&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;cifar-stage-1&#39;</span><span class="p">,</span> <span class="n">rendezvous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>  
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start training processes</span>
<span class="k">def</span> <span class="nf">_mp_fn4</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS3</span>
    <span class="n">FLAGS3</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_cifar_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># %%time</span>
<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn4</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS3</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS3</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
        <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>xla 7 start train cifar model
xla 6 start train cifar model
xla 5 start train cifar model
xla 1 start train cifar model
xla 0 start train cifar model
xla 2 start train cifar model
xla 4 start train cifar model
xla 3 start train cifar model
train: True xla 5: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: True xla 6: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
build learner
start running fit
start fit
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.852744</td>
      <td>1.288982</td>
      <td>0.562738</td>
      <td>01:37</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.274965</td>
      <td>0.989299</td>
      <td>0.660244</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.996092</td>
      <td>0.830739</td>
      <td>0.713980</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.854135</td>
      <td>0.755246</td>
      <td>0.740147</td>
      <td>01:33</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.781868</td>
      <td>0.729593</td>
      <td>0.749387</td>
      <td>01:27</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>train: True xla 0: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:1
train: True xla 7: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: True xla 2: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: True xla 1: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: True xla 3: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: True xla 4: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 3: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 6: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 5: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 1: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 7: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 4: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 2: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:0
train: False xla 0: dl.type: &lt;class &#39;torch.utils.data.dataloader.DataLoader&#39;&gt; dl.device None model.device: xla:1
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

