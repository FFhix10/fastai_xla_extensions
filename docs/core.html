---

title: Core XLA extensions

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setup-torch-XLA">Setup torch XLA<a class="anchor-link" href="#Setup-torch-XLA"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="c1">#colab</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;20200325&quot;</span>  <span class="c1">#@param [&quot;1.5&quot; , &quot;20200325&quot;, &quot;nightly&quot;]</span>
<span class="o">!</span>curl https://raw.githubusercontent.com/pytorch/xla/master/contrib/scripts/env-setup.py -o pytorch-xla-env-setup.py
<span class="o">!</span>python pytorch-xla-env-setup.py --version <span class="nv">$VERSION</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Install fastai2</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="c1">#colab</span>
<span class="o">!</span>pip install fastai2 --upgrade &gt; /dev/null
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="c1">#exporti</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XLA-OptFunc-Wrapper">XLA OptFunc Wrapper<a class="anchor-link" href="#XLA-OptFunc-Wrapper"> </a></h2><p>Wraps the <code>opt_func</code> (which is a fastai function that creates an <em>Optimizer</em>) with a class such that calling the class returns a fastai <code>OptimWrapper</code> which has been monkeypatched to call the Pytorch-XLA function <code>xm.optimizer_step</code> which synchronizes the XLA graph.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLAOptFuncWrapper" class="doc_header"><code>class</code> <code>XLAOptFuncWrapper</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L13" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLAOptFuncWrapper</code>(<strong><code>f</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example:-Create-an-MNIST-classifier">Example: Create an MNIST classifier<a class="anchor-link" href="#Example:-Create-an-MNIST-classifier"> </a></h3><p>Import fastai libraries</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.vision.all</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Load data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_SAMPLE</span><span class="p">)</span>
<span class="n">Path</span><span class="o">.</span><span class="n">BASE_PATH</span> <span class="o">=</span> <span class="n">path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create datablock</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datablock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">(</span><span class="n">cls</span><span class="o">=</span><span class="n">PILImageBW</span><span class="p">),</span><span class="n">CategoryBlock</span><span class="p">),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(),</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Get-TPU-device">Get TPU device<a class="anchor-link" href="#Get-TPU-device"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="n">tpu</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Set dataloader to load the batches to the tpu</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">datablock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tpu</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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zDNFpu1seMEFF4isbNmyYUqMHHcAAAAwiAYAAACDaAAAADCIBgAAAINK5BCgtmvZoUOH1GO1xzvm5+eL7C9/+YvIli9fLjJtOC83N1dkN910k1rPjBkzRLZ161aRXX755SKrWbOmek7ER8WKFUU2ePDgjFz766+/FtlTTz2V9PkuueSSVMpBDGnDa++9914ElRTtxx9/FJm2tps3by6yc889V2Ta7n7OOde6deskqssu3AEAAMAgGgAAAAyiAQAAwCAaAAAADIrtEOD69etFtmnTJpF9++23Itu9e7fI7rvvvpTq0XZR69mzZ6hM2/7vEqAAAAlLSURBVCFLq9s555599lmRaYNjzz33nMiyZfcpnNiePXtEtmrVKvXYN954Q2SrV68W2dy5c0WmPa41rKIeTwwkQxvu0wattcdfv/nmmyIbMWKEyO68806RValSJWyJJQ53AAAAMIgGAAAAg2gAAAAwiAYAAACDaAAAADAotj8F8Mtf/lJkeXl5oV4bBIHItC16nXNu4MCBIuvatavIzj77bJFp0/lhTZo0Sc216e8+ffqI7NRTT0362oiXadOmiWzUqFEi+/777zNQTXh//OMf1Xz+/Pki0yaytW1ZUfLt3LlTzR977DGRjR07VmT169cX2ccffyyyCy64IInqbOEOAAAABtEAAABgEA0AAAAG0QAAAGCQ1wbm/stxP1ic3nnnHZHl5+eLrGnTpiJr1KhRsdSUrB07doisVq1a6rGdO3cW2d///ve015Qh+uRlZkW2hjXaVs99+/YV2eHDhzNQTeaUK1dOZO3atROZ9vmpXLlycZQUVhzWsHMxW8dhaYPbzZs3V48tLCwU2fDhw0V2yy23iOyUU05JojpT1HXMHQAAAAyiAQAAwCAaAAAADKIBAADAoNgOAZYkv/rVr0T24YcfqseuWLFCZNqgY5aIwwBVrNZw7dq1RbZ9+/aMXPuyyy4TWcuWLUWm7TypmTJlipprO7qF1axZM5EtXLhQZBkc+orDGnYuZutYow38XXjhhSLbvXu3+vovvvhCZA0aNEi9sDSaPXt2qOM6depUzJUkjCFAAABwDA0AAAAG0QAAAGAQDQAAAAbF9nHA2Wrjxo0iW758uchGjhypvr5x48ZprwnxMX78eJH16NFDZBdffLHIKlWqFPo699xzj8hat24tspycnNDn/CntEb9F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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="p">(</span><span class="n">xb</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(device(type=&#39;xla&#39;, index=1), torch.Size([64, 1, 28, 28]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-OptFunc">Configure OptFunc<a class="anchor-link" href="#Configure-OptFunc"> </a></h3><p>Wrap the opt_func with an XLA wrapper so that
the optimizer will call <code>xm.optimizer_step(opt)</code> instead of <code>opt.step</code> in the step method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">XLAAdam</span> <span class="o">=</span> <span class="n">XLAOptFuncWrapper</span><span class="p">(</span><span class="n">Adam</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">XLAAdam</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading: &#34;https://download.pytorch.org/models/resnet18-5c106cde.pth&#34; to /root/.cache/torch/checkpoints/resnet18-5c106cde.pth
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.107523</td>
      <td>0.057359</td>
      <td>0.982826</td>
      <td>00:34</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.022053</td>
      <td>0.003913</td>
      <td>0.999019</td>
      <td>00:31</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

