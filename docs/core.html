---

title: Core XLA extensions


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install-fastai">Install fastai<a class="anchor-link" href="#Install-fastai"> </a></h2><p>Use latest fastai and fastcore versions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="o">![</span> -d /content <span class="o">]</span> <span class="o">&amp;&amp;</span> pip install -Uqq fastcore --upgrade
<span class="o">![</span> -d /content <span class="o">]</span> <span class="o">&amp;&amp;</span> pip install -Uqq fastai --upgrade
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-torch-XLA">Setup torch XLA<a class="anchor-link" href="#Setup-torch-XLA"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the official way to install Pytorch-XLA 1.7 <a href="https://colab.research.google.com/github/pytorch/xla/blob/master/contrib/colab/getting-started.ipynb#scrollTo=CHzziBW5AoZH">instructions here</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="o">![</span> -d /content <span class="o">]</span> <span class="o">&amp;&amp;</span> pip install -Uqq cloud-tpu-client<span class="o">==</span><span class="m">0</span>.10 https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-1.7-cp36-cp36m-linux_x86_64.whl
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Check-if-XLA-is-available">Check if XLA is available<a class="anchor-link" href="#Check-if-XLA-is-available"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="xla_imported" class="doc_header"><code>xla_imported</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>xla_imported</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="xla_available_config" class="doc_header"><code>xla_available_config</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>xla_available_config</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="xla_module_exist" class="doc_header"><code>xla_module_exist</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>xla_module_exist</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This next code routine handles the possibility of running the package when the environment does not provide a TPU (e.g. CI env, local, etc) by providing mock implementations</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Patching-BaseOptimizer-to-be-Pickable">Patching BaseOptimizer to be Pickable<a class="anchor-link" href="#Patching-BaseOptimizer-to-be-Pickable"> </a></h2><p>Patching Base Optimizer <a href="/fastai_xla_extensions/core.html#__getstate__"><code>__getstate__</code></a> and <a href="/fastai_xla_extensions/core.html#__setstate__"><code>__setstate__</code></a> whichi is used in pickling
the optimizer which should fix the bug in running the learner in multiple TPU cores
in XLA by which the  <code>def _fetch_gradients(optimizer)</code> in <code>for param_group in optimizer.__getstate__()['param_groups']:</code> fails, and this patch fixes the "copy constructor" to include the param_groups.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XLA-Optim-Proxy">XLA Optim Proxy<a class="anchor-link" href="#XLA-Optim-Proxy"> </a></h2><p><a href="/fastai_xla_extensions/core.html#XLAOptimProxy"><code>XLAOptimProxy</code></a> is a class which has overridden the <code>step</code> method to call the Pytorch-XLA function <code>xm.optimizer_step</code> which synchronizes the XLA graph. All other calls to <a href="/fastai_xla_extensions/core.html#XLAOptimProxy"><code>XLAOptimProxy</code></a> just forward it to the internal <code>self.opt</code> instance.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLAOptimProxy" class="doc_header"><code>class</code> <code>XLAOptimProxy</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L90" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLAOptimProxy</code>(<strong><code>opt</code></strong>, <strong><code>barrier</code></strong>) :: <code>GetAttr</code></p>
</blockquote>
<p>Inherit from this to have all attr accesses in <code>self._xtra</code> passed down to <code>self.default</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="DeviceMoverTransform">DeviceMoverTransform<a class="anchor-link" href="#DeviceMoverTransform"> </a></h2><p><a href="/fastai_xla_extensions/core.html#DeviceMoverTransform"><code>DeviceMoverTransform</code></a> is a simple transform that moves the batch input from the CPU to the XLA device.</p>
<p>This is in lieu of the normal mechanism of the DataLoader implementation where the dls.device is set to the XLA device before the start of any batch transformations in the dataloaders.</p>
<p>Unfortunately, the AffineCoordTfm which is used for data augmentation (all the batch Zoom, Warp, Rotate augmentations) cause a problem when run on the TPU due to some affine operations not currently implemented in the Pytorch XLA) which triggers a lowering of the XLA Tensors to the CPU to perform the affine operation and causes a massive slowdown, even much slower than just doing the affine transform in the CPU in the first place.</p>
<p>The solution is then to postpone the moving of the input batch to TPU after the affine transformation, by setting the dls.device to None, which is done in the before_fit method of the XLAOptCallback.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DeviceMoverTransform" class="doc_header"><code>class</code> <code>DeviceMoverTransform</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L109" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DeviceMoverTransform</code>(<strong><code>device_to</code></strong>, <strong><code>device_from</code></strong>=<em><code>device(type='cpu')</code></em>) :: <code>DisplayedTransform</code></p>
</blockquote>
<p>Transform to move input to new device and reverse to cpu</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="has_affinecoord_tfm" class="doc_header"><code>has_affinecoord_tfm</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L130" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>has_affinecoord_tfm</code>(<strong><code>dls</code></strong>:<code>DataLoaders</code>)</p>
</blockquote>
<p>returns true if train dataloader has an AffineCoordTfm in the batch_tfms</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="has_devicemover_tfm" class="doc_header"><code>has_devicemover_tfm</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>has_devicemover_tfm</code>(<strong><code>dl</code></strong>:<code>DataLoader</code>)</p>
</blockquote>
<p>returns true if train dataloader has a DeviceMoverTransform in the batch_tfms</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_last_affinecoord_tfm_idx" class="doc_header"><code>get_last_affinecoord_tfm_idx</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L139" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_last_affinecoord_tfm_idx</code>(<strong><code>dl</code></strong>:<code>DataLoader</code>)</p>
</blockquote>
<p>returns index of last AffineCoordTfm if it exists, otherwise returns -1</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="insert_batch_tfm" class="doc_header"><code>insert_batch_tfm</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L146" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>insert_batch_tfm</code>(<strong><code>dl</code></strong>:<code>DataLoader</code>, <strong><code>batch_tfm</code></strong>:<code>Transform</code>, <strong><code>idx</code></strong>:<code>int</code>)</p>
</blockquote>
<p>adds a batch_tfm in the batch_tfms for the dataloader at idx location</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="setup_input_device_mover" class="doc_header"><code>setup_input_device_mover</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L156" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>setup_input_device_mover</code>(<strong><code>learn</code></strong>:<code>Learner</code>, <strong><code>new_device</code></strong>)</p>
</blockquote>
<p>setup batch_tfms to use cpu if dataloader batch_tfms has AffineCoordTfms</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XLA-Opt-Callback">XLA Opt Callback<a class="anchor-link" href="#XLA-Opt-Callback"> </a></h2><p>This callback replaces the learner's <code>opt</code> with an instance of <a href="/fastai_xla_extensions/core.html#XLAOptimProxy"><code>XLAOptimProxy</code></a> that proxies the original <code>opt</code> during the beginning of the <code>fit</code> method and restores the original <code>opt</code> after the <code>fit</code>.</p>
<p>It also sets the <code>dataloaders.device</code> and the <code>learn.model</code> to use a TPU core using the device returned by the <code>xm.xla_device()</code> method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLAOptCallback" class="doc_header"><code>class</code> <code>XLAOptCallback</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L180" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLAOptCallback</code>(<strong><code>barrier</code></strong>=<em><code>True</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Callback to replace <code>opt.step</code> with <code>xm.optimizer_step(opt)</code> as required to run on TPU</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If XLA is available, then it is assumed that XLA is intended 
to be used -- this requires the following:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>The <a href="/fastai_xla_extensions/core.html#XLAOptCallback"><code>XLAOptCallback</code></a> (which enables the <code>Learner</code> to call <code>xm.optimizer_step</code> via the <a href="/fastai_xla_extensions/core.html#XLAOptimProxy"><code>XLAOptimProxy</code></a>) is not automatically added as a default callback. </li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Override the <code>Learner.summary</code> method to set the <code>learner.dls</code> to use an <code>xla_device</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Make sure the model and dataloader has been moved to the xla device prior to creating the optimizer</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.to_xla" class="doc_header"><code>Learner.to_xla</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L263" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.to_xla</code>(<strong><code>new_device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.detach_xla" class="doc_header"><code>Learner.detach_xla</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L275" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.detach_xla</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example:-Create-an-MNIST-classifier">Example: Create an MNIST classifier<a class="anchor-link" href="#Example:-Create-an-MNIST-classifier"> </a></h2><p>This is an example of the fastai_xla_extensions library
in action.</p>
<p>First, we import fastai libraries.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.callback.training</span> <span class="kn">import</span> <span class="n">GradientAccumulation</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Load data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="n">Path</span><span class="o">.</span><span class="n">BASE_PATH</span> <span class="o">=</span> <span class="n">path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create datablock</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datablock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span><span class="n">CategoryBlock</span><span class="p">),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(),</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="n">aug_transforms</span><span class="p">(</span><span class="n">do_flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span> <span class="c1"># trigger usage of RandomResizedCropGPU</span>
    <span class="c1"># batch_tfms=[]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Set dataloader to load the batches to the cpu</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">datablock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cpu&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#4) [IntToFloatTensor -- {&#39;div&#39;: 255.0, &#39;div_mask&#39;: 1}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
,Warp -- {&#39;magnitude&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw_x&#39;: None, &#39;draw_y&#39;: None, &#39;size&#39;: None, &#39;mode&#39;: &#39;bilinear&#39;, &#39;pad_mode&#39;: &#39;reflection&#39;, &#39;batch&#39;: False, &#39;align_corners&#39;: True, &#39;mode_mask&#39;: &#39;nearest&#39;}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
(TensorBBox,object) -&gt; encodes
(TensorPoint,object) -&gt; encodes
decodes: ,RandomResizedCropGPU -- {&#39;size&#39;: None, &#39;min_scale&#39;: 0.8, &#39;ratio&#39;: (1, 1), &#39;mode&#39;: &#39;bilinear&#39;, &#39;valid_scale&#39;: 1.0, &#39;p&#39;: 1.0}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Brightness -- {&#39;max_lighting&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw&#39;: None, &#39;batch&#39;: False}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIHCAYAAADpfeRCAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADh0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4yLjIsIGh0dHA6Ly9tYXRwbG90bGliLm9yZy+WH4yJAAAgAElEQVR4nO3deZDV1Z338fOzV2gaGrBZZWvZkVUUBIGggxBAo5LEFXEimcgkTpxo6UylppJokspUJTPxIRMf5zEqVkyiIFKgCEQQBOIgm44gyL430GzN3hu/54+Z5Mkz5/Mlfbtvc+/t835VWRU/+dbtI5x7/frje86N4jh2AAAgLFelegEAAODKowEAACBANAAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgGgAEhRF0dn/8VdNFEUzU70uIBHsY2Q69nD9Zad6AZkmjuNmf/zfURQ1c84dds7NTt2KgMSxj5Hp2MP1xxOA+pninDvqnFuZ6oUA9cA+RqZjD9cBDUD9THPOvRpznzIyG/sYmY49XAcRv151E0VRF+fcLudc9ziOd6d6PUBdsI+R6djDdccTgLqb6pxbxYZDhmMfI9Oxh+uIBqDuHnLOzUr1IoB6Yh8j07GH64g/AqiDKIpGOOd+75xrF8fxmVSvB6gL9jEyHXu4fngCUDfTnHNz2XDIcOxjZDr2cD3wBAAAgADxBAAAgADRAAAAECAaAAAAAkQDAABAgGgAAAAI0GW/DTCKIo4IoM7iOI5SvQb2MOojHfawc+xj1I+1j3kCAABAgGgAAAAIEA0AAAABogEAACBANAAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgGgAAAAIEA0AAAABogEAACBANAAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgGgAAAAIEA0AAAABogEAACBANAAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgGgAAAAIEA0AAAABogEAACBANAAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgLJTvYArKTc3V+ZdunTxsoKCAlnbq1cvmXfs2FHmRUVFXlZdXS1rk5En+hoXL16U+X/+53962bp162QtAKSLrKwsmWdn+/+6q6yslLXFxcUyv+mmm2Ter18/L2vevLms3bp1q8zff/99me/du1fmycATAAAAAkQDAABAgGgAAAAIEA0AAAABSrshwGHDhsm8d+/eXtanTx9Zm5eXl9DP7Ny5s5fl5OTI2vbt28u8Xbt2CeVKHMcytwb1oijysvz8/Fr/POecO3PmjMxfeuklL2MI8Mr5zne+I/PTp0/LfOnSpV62f/9+WWsNhAJXivX5qoavrc+0q6++WubdunWT+fDhw71s8ODBsrZHjx4yt9ZdWFjoZS1btpS11uf5G2+8IfO//du/9bLz58/L2kTxBAAAgADRAAAAECAaAAAAAkQDAABAgGgAAAAIUNqdArj77rtlPnHiRC9r06aNrL3qqsT6GnVl4549e2Tt0aNHZf7ee+/J/Pjx415mXVVZU1Mj8+3bt8tcXTP8yCOPyNquXbvK3FqLdbUxrowRI0bIXJ1YsXLralF1zbNzeq8CtWF9jkyZMkXmt99+u8zVCa6KigpZe80118j8uuuuk7n6vLxw4YKs3bVrl8y3bNki83PnznnZ0KFDE1pfz549Zd6iRQsv4xQAAACoMxoAAAACRAMAAECAaAAAAAgQDQAAAAFKu1MAq1evlvktt9ziZdbd9Ooee+ecu3Tpksyzs/1fBuvOdSs/e/aszNW0pnVKwVrfgQMHZD5mzBgvs75PwLr/fefOnTJ/9913ZY4rQ33Pg3POXX/99TLv37+/l6n94ZxzM2fOlPmCBQtkbk1hI0xNmzb1sscff1zWPvTQQzK3TrNUVVV52ZEjR2Stdaf+3r17Zb5s2TIvs/a8dVKmvLy81mv53ve+J2u7d+8u840bN8r81KlTMk8GngAAABAgGgAAAAJEAwAAQIBoAAAACBANAAAAAUq7UwCLFy+W+fr1673MmpQ+duyYzK16lVtT85WVlTJPBus+7WuvvVbmX/va17ysQ4cOstb6NXnzzTdl/tZbb8kcV4aahnbO3peqfsiQIbL26aeflvmwYcNkrk6hWHeR5+bmynzFihUy37Rpk8yRvtRJlOnTp8ta6wTJ/PnzZa7u2v/kk09k7bZt22RufY+L2rPqBJhz9veyWKesRo4c6WUDBw6UtdaprpUrV8rc+r6CZOAJAAAAAaIBAAAgQDQAAAAEiAYAAIAApd0QoDU0cvDgwSu8koZjDZ706tVL5k8++aTMx40b52WlpaWy9ne/+53M58yZI/MzZ87IHFfGyZMnZW69D3772996mTVIeNttt8l8ypQpMleDT9YwrPUzS0pKZP7cc8952b59+2Qt0oO6rv3b3/62rD169KjMrc8ptb+tgbxksIZqLX369JH5d7/7XS/r2bOnrH3hhRdkrq4qbmg8AQAAIEA0AAAABIgGAACAANEAAAAQIBoAAAAClHanABobNfFvTYd+85vflPldd90l87KyMi/7xS9+IWsXLlwo8x07dsgcqbVr1y6ZW1P25eXlXmad/LCuf7aunO7bt6+X9e/fX9beeOONMrdOHqxZs8bLOAWQ3i5duuRlixYtkrXWfk131omsZ599VuZjxozxMnV9vXPOvfbaazK3Tkw0JJ4AAAAQIBoAAAACRAMAAECAaAAAAAgQDQAAAAHiFECS5OTkyFxNUD/22GOy9otf/KLMT506JfNf/epXXvbGG2/I2sOHD8sc6Wnbtm0yt76jQZ02UScDnLOn7D///HOZf/jhh152ww03yNri4mKZDxgwQOZXX321zJFZMnXaP4oimd9zzz0ynzhxoszVBP/3v/99WWu9t1OBJwAAAASIBgAAgADRAAAAECAaAAAAAkQDAABAgDgFkKDc3FyZ9+7dW+YPPvigl1mTpMeOHZP5iy++KPN3333Xy5j2bxwKCgpkbu2/Vq1a1fo1rNMBlZWVMj9y5IiX7d+/X9aqe+Kds6fEDxw4IHMg2dR7Z8KECbL20Ucflfm5c+dk/oMf/MDLli1blsDqUoMnAAAABIgGAACAANEAAAAQIBoAAAACxBBggrp27Srz+++/X+aTJk3ysq1bt8ra3/72tzJ/++23ZV5WViZzZL68vDyZW0OA6kpdawgwGeI4lnmLFi1kzhAgrpQmTZrI/Etf+pKXPfPMM7LW2q8zZ86U+WuvvVbL1aUXngAAABAgGgAAAAJEAwAAQIBoAAAACBANAAAAAeIUgMGaZh48eLDMrSslc3JyvGzlypWydv78+TJXV7Gicdu9e7fMT58+LfN+/fp5mboeOFkOHTok88LCQpk3bdpU5ta1xMBfoj5bnXNu+PDhMv/GN77hZe3atZO1ixYtkvmsWbNkbl2jne54AgAAQIBoAAAACBANAAAAAaIBAAAgQDQAAAAEiFMATk+T3njjjbLWuvPfOjWwePFiL5s3b56sZdoff7R27VqZv/rqqzJX9/6XlpYmdU1/7tixYzKvqKiQeevWrWV+1VX8NwguLz8/X+bWtP/3vvc9masTXMuXL5e1zz//vMyPHj0q80zFuw8AgADRAAAAECAaAAAAAkQDAABAgGgAAAAIEKcAnJ74v++++2TtiBEjZL5161aZq3v/N27cmMDqEKJz587J/N///d9lnp3tv5WtifyGZE1JHz58WOaZeoc6rhzrRNYPfvADmVvf1/KHP/zBy5577rla1zrnXHV1tcwzFU8AAAAIEA0AAAABogEAACBANAAAAAQoqCHAHj16yPy2227zsltvvVXWWterqit/nXNuzZo1tVwd8JdZQ3NXepiusLBQ5tbVvmVlZTJv3rx50taEzNeyZUsvmz59uqwdNGiQzPfs2SPzn/70p162evVqWZuKAdpU4AkAAAABogEAACBANAAAAASIBgAAgADRAAAAEKBGeQqgRYsWMp8wYYLM77jjjlq/9tKlS2X+9ttvy3zHjh21fm3gSnjyySdlfuzYMZlfvHjRyw4dOiRry8vLZW6dGigoKJA5GrdOnTrJ/MEHH/Sy22+/XdaeOXNG5s8884zM1cS/2tsh4QkAAAABogEAACBANAAAAASIBgAAgADRAAAAEKBGeQrAuvN/2LBhMi8pKfEya6p/4cKFMt+yZUstVwek1v333y9z632TlZVVq8w557Kz9UeKdRqGUwCNQxRFMu/QoYPM/+7v/k7mU6dO9bITJ07I2pdeeknmb731lsxrampkHjKeAAAAECAaAAAAAkQDAABAgGgAAAAIEA0AAAAByuhTAPn5+TIfNWqUzPv37y/zjRs3etm7774ra9euXSvziooKmQPp5tFHH5X5uHHjZN6kSRMvKyoqkrUjR46Ued++fWV+6dIlL7MmyuM4ljlST52kcs65b37zmzL/yle+InN1KmTRokWy9kc/+lEtVwcLTwAAAAgQDQAAAAGiAQAAIEA0AAAABCijhwC7desm8xEjRiRUr66O/PDDD2VtVVWVzK2BxIsXL8ocSJWPPvoooVyxBvX+8R//UeZPPfWUzD///HMvY9gvvfXq1cvLvv3tb8var371qzJv3ry5zPfv31+rzDnnWrVqJXPr6mD4eAIAAECAaAAAAAgQDQAAAAGiAQAAIEA0AAAABCijTwG0b99e5h07dpS5Namfl5fnZdddd52s7dy5s8x37dol871798ocyGTWpP5nn30mc+u917p1ay87dOhQ3ReGpMnNzZX5ww8/7GWTJ0+W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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create the Learner</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="c1"># learner = cnn_learner(dls, resnet18, pretrained=False, metrics=accuracy) # see current bug re pretrained https://github.com/butchland/fastai_xla_extensions/issues/14 </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#5) [IntToFloatTensor -- {&#39;div&#39;: 255.0, &#39;div_mask&#39;: 1}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
,Warp -- {&#39;magnitude&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw_x&#39;: None, &#39;draw_y&#39;: None, &#39;size&#39;: None, &#39;mode&#39;: &#39;bilinear&#39;, &#39;pad_mode&#39;: &#39;reflection&#39;, &#39;batch&#39;: False, &#39;align_corners&#39;: True, &#39;mode_mask&#39;: &#39;nearest&#39;}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
(TensorBBox,object) -&gt; encodes
(TensorPoint,object) -&gt; encodes
decodes: ,RandomResizedCropGPU -- {&#39;size&#39;: None, &#39;min_scale&#39;: 0.8, &#39;ratio&#39;: (1, 1), &#39;mode&#39;: &#39;bilinear&#39;, &#39;valid_scale&#39;: 1.0, &#39;p&#39;: 1.0}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Brightness -- {&#39;max_lighting&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw&#39;: None, &#39;batch&#39;: False}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Normalize -- {&#39;mean&#39;: tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]]), &#39;std&#39;: tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]]), &#39;axes&#39;: (0, 2, 3)}:
encodes: (TensorImage,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">to_xla</span><span class="p">(</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">());</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>setup device mover dl: &lt;fastai.data.core.TfmdDL object at 0x7ff3028a9a90&gt; idx: 2
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#6) [IntToFloatTensor -- {&#39;div&#39;: 255.0, &#39;div_mask&#39;: 1}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
,Warp -- {&#39;magnitude&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw_x&#39;: None, &#39;draw_y&#39;: None, &#39;size&#39;: None, &#39;mode&#39;: &#39;bilinear&#39;, &#39;pad_mode&#39;: &#39;reflection&#39;, &#39;batch&#39;: False, &#39;align_corners&#39;: True, &#39;mode_mask&#39;: &#39;nearest&#39;}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
(TensorBBox,object) -&gt; encodes
(TensorPoint,object) -&gt; encodes
decodes: ,RandomResizedCropGPU -- {&#39;size&#39;: None, &#39;min_scale&#39;: 0.8, &#39;ratio&#39;: (1, 1), &#39;mode&#39;: &#39;bilinear&#39;, &#39;valid_scale&#39;: 1.0, &#39;p&#39;: 1.0}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,DeviceMoverTransform -- {&#39;device_to&#39;: device(type=&#39;xla&#39;, index=1), &#39;device_from&#39;: device(type=&#39;cpu&#39;)}:
encodes: (Tensor,object) -&gt; encodes
decodes: (Tensor,object) -&gt; decodes
,Brightness -- {&#39;max_lighting&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw&#39;: None, &#39;batch&#39;: False}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Normalize -- {&#39;mean&#39;: tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]]), &#39;std&#39;: tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]]), &#39;axes&#39;: (0, 2, 3)}:
encodes: (TensorImage,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#6) [IntToFloatTensor -- {&#39;div&#39;: 255.0, &#39;div_mask&#39;: 1}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
,Warp -- {&#39;magnitude&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw_x&#39;: None, &#39;draw_y&#39;: None, &#39;size&#39;: None, &#39;mode&#39;: &#39;bilinear&#39;, &#39;pad_mode&#39;: &#39;reflection&#39;, &#39;batch&#39;: False, &#39;align_corners&#39;: True, &#39;mode_mask&#39;: &#39;nearest&#39;}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
(TensorBBox,object) -&gt; encodes
(TensorPoint,object) -&gt; encodes
decodes: ,RandomResizedCropGPU -- {&#39;size&#39;: None, &#39;min_scale&#39;: 0.8, &#39;ratio&#39;: (1, 1), &#39;mode&#39;: &#39;bilinear&#39;, &#39;valid_scale&#39;: 1.0, &#39;p&#39;: 1.0}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,DeviceMoverTransform -- {&#39;device_to&#39;: device(type=&#39;xla&#39;, index=1), &#39;device_from&#39;: device(type=&#39;cpu&#39;)}:
encodes: (Tensor,object) -&gt; encodes
decodes: (Tensor,object) -&gt; decodes
,Brightness -- {&#39;max_lighting&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw&#39;: None, &#39;batch&#39;: False}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Normalize -- {&#39;mean&#39;: tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]]), &#39;std&#39;: tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]]), &#39;axes&#39;: (0, 2, 3)}:
encodes: (TensorImage,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>learner</code> object should have an <code>xla_opt</code> attribute which confirms that <a href="/fastai_xla_extensions/core.html#XLAOptCallback"><code>XLAOptCallback</code></a> has been added to the list of callbacks for this learner.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">xla_opt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>XLAOptCallback</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">xla_opt</span><span class="o">.</span><span class="n">barrier</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;xla&#39;, index=1)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">has_affinecoord_tfm</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">has_devicemover_tfm</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TRACE</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># currently an unrelated bug : https://github.com/fastai/fastai/issues/3011</span>
<span class="c1"># learner.summary()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># learner.show_training_loop()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CheckXLADeviceCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">before_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dls device: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1"> model device: </span><span class="si">{</span><span class="n">one_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dls device: None model device: </span><span class="si">{</span><span class="n">one_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">all_params</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;opt param device: </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">before_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dls device: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1"> model device: </span><span class="si">{</span><span class="n">one_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dls device: None model device: </span><span class="si">{</span><span class="n">one_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Run <code>fit</code> to train the model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">freeze_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">CheckXLADeviceCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dls device: None model device: xla:1
opt param device: xla:1
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.044283</td>
      <td>0.589799</td>
      <td>0.586552</td>
      <td>00:42</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.856989</td>
      <td>0.333799</td>
      <td>0.852647</td>
      <td>00:12</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.710016</td>
      <td>0.321834</td>
      <td>0.865522</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.624200</td>
      <td>0.324638</td>
      <td>0.871245</td>
      <td>00:15</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
opt param device: xla:1
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.465133</td>
      <td>0.254103</td>
      <td>0.912732</td>
      <td>00:20</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.388323</td>
      <td>0.191366</td>
      <td>0.925608</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.324011</td>
      <td>0.139396</td>
      <td>0.949928</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.281545</td>
      <td>0.108739</td>
      <td>0.964235</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.230670</td>
      <td>0.099597</td>
      <td>0.965665</td>
      <td>00:03</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.201774</td>
      <td>0.100754</td>
      <td>0.961373</td>
      <td>00:03</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
dls device: None model device: xla:1
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#6) [IntToFloatTensor -- {&#39;div&#39;: 255.0, &#39;div_mask&#39;: 1}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
,Warp -- {&#39;magnitude&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw_x&#39;: None, &#39;draw_y&#39;: None, &#39;size&#39;: None, &#39;mode&#39;: &#39;bilinear&#39;, &#39;pad_mode&#39;: &#39;reflection&#39;, &#39;batch&#39;: False, &#39;align_corners&#39;: True, &#39;mode_mask&#39;: &#39;nearest&#39;}:
encodes: (TensorImage,object) -&gt; encodes
(TensorMask,object) -&gt; encodes
(TensorBBox,object) -&gt; encodes
(TensorPoint,object) -&gt; encodes
decodes: ,RandomResizedCropGPU -- {&#39;size&#39;: None, &#39;min_scale&#39;: 0.8, &#39;ratio&#39;: (1, 1), &#39;mode&#39;: &#39;bilinear&#39;, &#39;valid_scale&#39;: 1.0, &#39;p&#39;: 1.0}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,DeviceMoverTransform -- {&#39;device_to&#39;: device(type=&#39;xla&#39;, index=1), &#39;device_from&#39;: device(type=&#39;cpu&#39;)}:
encodes: (Tensor,object) -&gt; encodes
decodes: (Tensor,object) -&gt; decodes
,Brightness -- {&#39;max_lighting&#39;: 0.2, &#39;p&#39;: 1.0, &#39;draw&#39;: None, &#39;batch&#39;: False}:
encodes: (TensorImage,object) -&gt; encodes
decodes: ,Normalize -- {&#39;mean&#39;: tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]]), &#39;std&#39;: tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]]), &#39;axes&#39;: (0, 2, 3)}:
encodes: (TensorImage,object) -&gt; encodes
decodes: (TensorImage,object) -&gt; decodes
]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>False</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;xla&#39;, index=1)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Path(&#39;models/stage-1.pth&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7ff2fcf59ba8&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">to_xla</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7ff2fcf59ba8&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="n">CheckXLADeviceCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dls device: None model device: xla:1
opt param device: xla:1
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.148499</td>
      <td>0.091807</td>
      <td>0.962804</td>
      <td>00:29</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dls device: None model device: xla:1
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">detach_xla</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7ff2fcf59ba8&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-98-1fb6be3579a2&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>learner<span class="ansi-blue-fg">.</span>export<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">export</span><span class="ansi-blue-fg">(self, fname, pickle_module, pickle_protocol)</span>
<span class="ansi-green-intense-fg ansi-bold">    543</span>         <span class="ansi-red-fg">#To avoid the warning that come from PyTorch about model not being checked</span>
<span class="ansi-green-intense-fg ansi-bold">    544</span>         warnings<span class="ansi-blue-fg">.</span>simplefilter<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;ignore&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 545</span><span class="ansi-red-fg">         </span>torch<span class="ansi-blue-fg">.</span>save<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>path<span class="ansi-blue-fg">/</span>fname<span class="ansi-blue-fg">,</span> pickle_module<span class="ansi-blue-fg">=</span>pickle_module<span class="ansi-blue-fg">,</span> pickle_protocol<span class="ansi-blue-fg">=</span>pickle_protocol<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    546</span>     self<span class="ansi-blue-fg">.</span>create_opt<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    547</span>     <span class="ansi-green-fg">if</span> state <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>load_state_dict<span class="ansi-blue-fg">(</span>state<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/torch/serialization.py</span> in <span class="ansi-cyan-fg">save</span><span class="ansi-blue-fg">(obj, f, pickle_module, pickle_protocol, _use_new_zipfile_serialization)</span>
<span class="ansi-green-intense-fg ansi-bold">    370</span>         <span class="ansi-green-fg">if</span> _use_new_zipfile_serialization<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    371</span>             <span class="ansi-green-fg">with</span> _open_zipfile_writer<span class="ansi-blue-fg">(</span>opened_file<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">as</span> opened_zipfile<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 372</span><span class="ansi-red-fg">                 </span>_save<span class="ansi-blue-fg">(</span>obj<span class="ansi-blue-fg">,</span> opened_zipfile<span class="ansi-blue-fg">,</span> pickle_module<span class="ansi-blue-fg">,</span> pickle_protocol<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    373</span>                 <span class="ansi-green-fg">return</span>
<span class="ansi-green-intense-fg ansi-bold">    374</span>         _legacy_save<span class="ansi-blue-fg">(</span>obj<span class="ansi-blue-fg">,</span> opened_file<span class="ansi-blue-fg">,</span> pickle_module<span class="ansi-blue-fg">,</span> pickle_protocol<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/torch/serialization.py</span> in <span class="ansi-cyan-fg">_save</span><span class="ansi-blue-fg">(obj, zip_file, pickle_module, pickle_protocol)</span>
<span class="ansi-green-intense-fg ansi-bold">    474</span>     pickler <span class="ansi-blue-fg">=</span> pickle_module<span class="ansi-blue-fg">.</span>Pickler<span class="ansi-blue-fg">(</span>data_buf<span class="ansi-blue-fg">,</span> protocol<span class="ansi-blue-fg">=</span>pickle_protocol<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    475</span>     pickler<span class="ansi-blue-fg">.</span>persistent_id <span class="ansi-blue-fg">=</span> persistent_id
<span class="ansi-green-fg">--&gt; 476</span><span class="ansi-red-fg">     </span>pickler<span class="ansi-blue-fg">.</span>dump<span class="ansi-blue-fg">(</span>obj<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    477</span>     data_value <span class="ansi-blue-fg">=</span> data_buf<span class="ansi-blue-fg">.</span>getvalue<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    478</span>     zip_file<span class="ansi-blue-fg">.</span>write_record<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;data.pkl&#39;</span><span class="ansi-blue-fg">,</span> data_value<span class="ansi-blue-fg">,</span> len<span class="ansi-blue-fg">(</span>data_value<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/fastai/torch_core.py</span> in <span class="ansi-cyan-fg">__reduce_ex__</span><span class="ansi-blue-fg">(self, proto)</span>
<span class="ansi-green-intense-fg ansi-bold">    309</span>     <span class="ansi-green-fg">def</span> __reduce_ex__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>proto<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    310</span>         torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>hooks<span class="ansi-blue-fg">.</span>warn_if_has_hooks<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 311</span><span class="ansi-red-fg">         </span>args <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>type<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>storage<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>storage_offset<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> tuple<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>stride<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    312</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>is_quantized<span class="ansi-blue-fg">:</span> args <span class="ansi-blue-fg">=</span> args <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>q_scale<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>q_zero_point<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    313</span>         f <span class="ansi-blue-fg">=</span> _fa_rebuild_qtensor <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>is_quantized <span class="ansi-green-fg">else</span>  _fa_rebuild_tensor

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/fastai/torch_core.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(self, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    317</span> <span class="ansi-red-fg">#         if func.__name__[0]!=&#39;_&#39;: print(func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    318</span> <span class="ansi-red-fg">#         with torch._C.DisableTorchFunction(): ret = _convert(func(*args, **(kwargs or {})), self.__class__)</span>
<span class="ansi-green-fg">--&gt; 319</span><span class="ansi-red-fg">         </span>ret <span class="ansi-blue-fg">=</span> super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__torch_function__<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> types<span class="ansi-blue-fg">,</span> args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span> kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    320</span>         <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">,</span> TensorBase<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> ret<span class="ansi-blue-fg">.</span>set_meta<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> as_copy<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    321</span>         <span class="ansi-green-fg">return</span> ret

<span class="ansi-green-fg">/usr/local/lib/python3.6/dist-packages/torch/tensor.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(cls, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    993</span> 
<span class="ansi-green-intense-fg ansi-bold">    994</span>         <span class="ansi-green-fg">with</span> _C<span class="ansi-blue-fg">.</span>DisableTorchFunction<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 995</span><span class="ansi-red-fg">             </span>ret <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    996</span>             <span class="ansi-green-fg">return</span> _convert<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">,</span> cls<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    997</span> 

<span class="ansi-red-fg">RuntimeError</span>: torch_xla/csrc/tensor_impl.cpp:144 : XLA tensors do not have storage</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-2&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-2&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_images</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">freeze_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">CheckXLADeviceCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">after_batch</span><span class="o">.</span><span class="n">fs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># def call_fit(learner,epochs=1):</span>
<span class="c1">#     set_trace()</span>
<span class="c1">#     learner.fit(epochs, cbs=[CheckXLADeviceCallback()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TRACE</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">2e-2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1e-4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">freeze_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">CheckXLADeviceCallback</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">2e-6</span><span class="p">,</span><span class="mf">7e-4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1e-4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Gradient Accum callback (which calls CancelBatchException) should still work.</p>
<p>An alternative design for the XLA Opt Callback which raises the CancelBatchException in the <code>after_backward</code> method (after executing <code>xm.optimizer_step</code> and <code>opt.zero_grad</code>) would interfere with the Gradient Accum callback (which raises <code>CancelBatchException</code> in the <code>after_backward</code> method to <a href="https://github.com/fastai/fastai/blob/master/fastai/callback/training.py#L22">skip the gradient updates</a> in order to accumulate the gradients).</p>
<p>The current design (add/remove <a href="/fastai_xla_extensions/core.html#XLAOptimProxy"><code>XLAOptimProxy</code></a> during <code>before_fit</code> and <code>after_fit</code> callback lifecycle methods) is less disruptive and more compatible with other callbacks.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">GradientAccumulation</span><span class="p">(</span><span class="n">n_acc</span><span class="o">=</span><span class="mi">2</span><span class="p">),])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Valid loss has kind of plateaued so this look ok.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Plot moms and lr across batches/epochs</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot_sched</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get Classification Interpretation for more details on model performance</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Plot confusion matrix</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Samples where model was most confused</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>End of Notebook</strong></p>

</div>
</div>
</div>
</div>
 

