---

title: Core XLA extensions

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/butch/Google Drive/fastai_xla_extensions/fastai_xla_extensions/core.py:14: RuntimeWarning: fastai_xla_extensions requires Pytorch-XLA, will revert to default
  RuntimeWarning)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setup-torch-XLA">Setup torch XLA<a class="anchor-link" href="#Setup-torch-XLA"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="c1">#colab</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;20200325&quot;</span>  <span class="c1">#@param [&quot;1.5&quot; , &quot;20200325&quot;, &quot;nightly&quot;]</span>
<span class="o">!</span>curl https://raw.githubusercontent.com/pytorch/xla/master/contrib/scripts/env-setup.py -o pytorch-xla-env-setup.py
<span class="o">!</span>python pytorch-xla-env-setup.py --version <span class="nv">$VERSION</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Install fastai2</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="c1">#colab</span>
<span class="o">!</span>pip install fastai2 --upgrade &gt; /dev/null
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Check-if-XLA-is-available">Check if XLA is available<a class="anchor-link" href="#Check-if-XLA-is-available"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Fake-XLA-functionality-if-XLA-not-available">Fake XLA functionality if XLA not available<a class="anchor-link" href="#Fake-XLA-functionality-if-XLA-not-available"> </a></h3><p>if TPU not available, fake xm to call opt.step anyway, 
and fake xla_device to return gpu if available, else return cpu
to ensure compatible behavior in using fastai_xla_extensions as 
normal fastai behavior if TPU not available</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XLA-Optim-Proxy">XLA Optim Proxy<a class="anchor-link" href="#XLA-Optim-Proxy"> </a></h2><p><a href="/fastai_xla_extensions/core#XLAOptimProxy"><code>XLAOptimProxy</code></a> is a class which has overridden the <code>step</code> method to call the Pytorch-XLA function <code>xm.optimizer_step</code> which synchronizes the XLA graph. All other calls to <a href="/fastai_xla_extensions/core#XLAOptimProxy"><code>XLAOptimProxy</code></a> just forward it to the internal <code>self.opt</code> instance.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLAOptimProxy" class="doc_header"><code>class</code> <code>XLAOptimProxy</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLAOptimProxy</code>(<strong><code>opt</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XLA-OptFunc-Wrapper">XLA OptFunc Wrapper<a class="anchor-link" href="#XLA-OptFunc-Wrapper"> </a></h2><p>Wraps the <code>opt_func</code> (which is a fastai function that creates an <code>Optimizer</code>) with an object that when called returns an <code>Optimizer</code> object wrapped around an <a href="/fastai_xla_extensions/core#XLAOptimProxy"><code>XLAOptimProxy</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLAOptFuncWrapper" class="doc_header"><code>class</code> <code>XLAOptFuncWrapper</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/core.py#L46" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLAOptFuncWrapper</code>(<strong><code>f</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example:-Create-an-MNIST-classifier">Example: Create an MNIST classifier<a class="anchor-link" href="#Example:-Create-an-MNIST-classifier"> </a></h3><p>Import fastai libraries</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Load data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="n">Path</span><span class="o">.</span><span class="n">BASE_PATH</span> <span class="o">=</span> <span class="n">path</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create datablock</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">datablock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="n">PILImageBW</span><span class="p">),</span><span class="n">CategoryBlock</span><span class="p">),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(),</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[]</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Get-TPU-device">Get TPU device<a class="anchor-link" href="#Get-TPU-device"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#colab</span>
<span class="n">tpu</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Set dataloader to load the batches to the tpu</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">datablock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">tpu</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="p">(</span><span class="n">xb</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">xb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(device(type=&#39;xla&#39;, index=1), torch.Size([64, 1, 28, 28]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-OptFunc">Configure OptFunc<a class="anchor-link" href="#Configure-OptFunc"> </a></h3><p>Wrap the opt_func with an XLA wrapper so that
the optimizer will call <code>xm.optimizer_step(opt)</code> instead of <code>opt.step</code> in the step method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">XLAAdam</span> <span class="o">=</span> <span class="n">XLAOptFuncWrapper</span><span class="p">(</span><span class="n">Adam</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">XLAAdam</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading: &#34;https://download.pytorch.org/models/resnet18-5c106cde.pth&#34; to /root/.cache/torch/checkpoints/resnet18-5c106cde.pth
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.898477</td>
      <td>0.235039</td>
      <td>0.922747</td>
      <td>00:14</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.357270</td>
      <td>0.209772</td>
      <td>0.912732</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

