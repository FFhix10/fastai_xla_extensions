---

title: Multi Core XLA extensions


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/03_multi_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_multi_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-torch-XLA">Setup torch XLA<a class="anchor-link" href="#Setup-torch-XLA"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the official way to install Pytorch-XLA 1.7 <a href="https://colab.research.google.com/github/pytorch/xla/blob/master/contrib/colab/getting-started.ipynb#scrollTo=CHzziBW5AoZH">instructions here</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -Uqq cloud-tpu-client<span class="o">==</span><span class="m">0</span>.10 https://storage.googleapis.com/tpu-pytorch/wheels/torch_xla-1.7-cp36-cp36m-linux_x86_64.whl
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>     |████████████████████████████████| 133.6MB 59kB/s 
     |████████████████████████████████| 61kB 2.4MB/s 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install-fastai">Install fastai<a class="anchor-link" href="#Install-fastai"> </a></h2><p>Use latest fastai and fastcore versions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># !pip install -Uqq git+https://github.com/fastai/fastai.git </span>
<span class="o">!</span>pip install -Uqq fastai --upgrade
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>     |████████████████████████████████| 194kB 5.1MB/s 
     |████████████████████████████████| 61kB 3.8MB/s 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Start of kernel</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Patching-BaseOptimizer-to-be-Pickable">Patching BaseOptimizer to be Pickable<a class="anchor-link" href="#Patching-BaseOptimizer-to-be-Pickable"> </a></h2><p>Patching Base Optimizer <a href="/fastai_xla_extensions/multi_core.html#__getstate__"><code>__getstate__</code></a> and <a href="/fastai_xla_extensions/multi_core.html#__setstate__"><code>__setstate__</code></a> whichi is used in pickling
the optimizer which should fix the bug in running the learner in multiple TPU cores
in XLA by which the  <code>def _fetch_gradients(optimizer)</code> in <code>for param_group in optimizer.__getstate__()['param_groups']:</code> fails, and this patch fixes the "copy constructor" to include the param_groups.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TPUDistributedDL" class="doc_header"><code>class</code> <code>TPUDistributedDL</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L92" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TPUDistributedDL</code>(<strong><code>dl</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>seed</code></strong>=<em><code>42</code></em>) :: <code>TfmdDL</code></p>
</blockquote>
<p>A <code>TfmdDL</code> which splits a batch into equal size pieces for each TPU core
It also recasts the output of a batch from a Tensorbase subclass to
a regular tensor since the XLA Parallel loader doesnt seem compatible
to it.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TfmdTorchDS" class="doc_header"><code>class</code> <code>TfmdTorchDS</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L181" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TfmdTorchDS</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>An abstract class representing a :class:<code>Dataset</code>.</p>
<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite :meth:<code>__getitem__</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
:meth:<code>__len__</code>, which is expected to return the size of the dataset by many
:class:<code>~torch.utils.data.Sampler</code> implementations and the default options
of :class:<code>~torch.utils.data.DataLoader</code>.</p>
<p>.. note::
  :class:<code>~torch.utils.data.DataLoader</code> by default constructs a index
  sampler that yields integral indices.  To make it work with a map-style
  dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="to_list" class="doc_header"><code>to_list</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L204" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>to_list</code>(<strong><code>o</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="has_setup" class="doc_header"><code>has_setup</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L207" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>has_setup</code>(<strong><code>tfms</code></strong>)</p>
</blockquote>
<p>returns last index if at least 1 <code>tfm</code> in <code>tfms</code> has a method <code>setup</code> else return -1</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_setups" class="doc_header"><code>run_setups</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L212" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_setups</code>(<strong><code>tfms</code></strong>, <strong><code>items</code></strong>)</p>
</blockquote>
<p>run tfm setups including tfm for all items</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TorchDatasetBuilder" class="doc_header"><code>class</code> <code>TorchDatasetBuilder</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L226" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TorchDatasetBuilder</code>(<strong><code>source</code></strong>, <strong><code>get_items</code></strong>, <strong><code>splitter</code></strong>, <strong><code>x_tfms</code></strong>, <strong><code>y_tfms</code></strong>, <strong><code>x_type_tfms</code></strong>=<em><code>None</code></em>, <strong><code>x_train_tfms</code></strong>=<em><code>None</code></em>, <strong><code>x_test_tfms</code></strong>=<em><code>None</code></em>, <strong><code>do_setup</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="VocabularyMapper" class="doc_header"><code>class</code> <code>VocabularyMapper</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L271" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>VocabularyMapper</code>(<strong><code>vocab</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>A simplified version of the fastai Categorize Transform</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torchvision</span> <span class="k">as</span> <span class="nn">thv</span>

<span class="n">pil2tensor</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="n">resize28</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">GrandparentSplitter</span><span class="p">,</span> <span class="n">parent_label</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">MNIST_TINY</span><span class="p">)</span>
<span class="n">mnist_dset_builder</span> <span class="o">=</span>  <span class="n">TorchDatasetBuilder</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> 
                <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span> 
                <span class="n">splitter</span><span class="o">=</span><span class="n">GrandparentSplitter</span><span class="p">(),</span>
                <span class="n">x_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">resize28</span><span class="p">,</span><span class="n">pil2tensor</span><span class="p">,</span><span class="n">norm</span><span class="p">,],</span> 
                <span class="n">y_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">parent_label</span><span class="p">,</span><span class="n">VocabularyMapper</span><span class="p">(),],</span>
                <span class="n">x_type_tfms</span><span class="o">=</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="n">test_eq</span>

<span class="n">train_ds</span><span class="p">,</span> <span class="n">test_ds</span> <span class="o">=</span> <span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">(</span><span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">),</span><span class="mi">709</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_ds</span><span class="p">),</span><span class="mi">699</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">mnist_dset_builder</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="None" class="doc_header"><code>None</code><a href="" class="source_link" style="float:right">[source]</a></h4>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_torch_dataloaders" class="doc_header"><code>make_torch_dataloaders</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L293" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_torch_dataloaders</code>(<strong><code>train_dataset</code></strong>, <strong><code>test_dataset</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>bs</code></strong>, <strong><code>num_workers</code></strong>=<em><code>4</code></em>, <strong><code>distrib</code></strong>=<em><code>True</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FileNamePatternLabeller" class="doc_header"><code>class</code> <code>FileNamePatternLabeller</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L358" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FileNamePatternLabeller</code>(<strong><code>pat_str</code></strong>, <strong><code>match</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Delayed action version of fastai RegexLabeller with file name selection</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_distributed_dataloaders" class="doc_header"><code>make_distributed_dataloaders</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L378" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_distributed_dataloaders</code>(<strong><code>dls</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Wrap dataloaders with distributed TPU aware dataloader</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_fastai_dataloaders" class="doc_header"><code>make_fastai_dataloaders</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L396" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_fastai_dataloaders</code>(<strong><code>datablock</code></strong>, <strong><code>source</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="wrap_parallel_loader" class="doc_header"><code>wrap_parallel_loader</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L403" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>wrap_parallel_loader</code>(<strong><code>loader</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="XLATrainingCallback" class="doc_header"><code>class</code> <code>XLATrainingCallback</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L418" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>XLATrainingCallback</code>(<strong><code>device</code></strong>, <strong><code>rank</code></strong>=<em><code>0</code></em>, <strong><code>sync_valid</code></strong>=<em><code>False</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="unpack_sync" class="doc_header"><code>unpack_sync</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L490" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>unpack_sync</code>(<strong><code>res</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SyncRecorderCallback" class="doc_header"><code>class</code> <code>SyncRecorderCallback</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L501" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SyncRecorderCallback</code>() :: <code>Callback</code></p>
</blockquote>
<p>Sync metrics from each spawned process update statistics
accordingly so it will display correctly in the progress callback</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_one_loop" class="doc_header"><code>do_one_loop</code><a href="https://github.com/butchland/fastai_xla_extensions/tree/master/fastai_xla_extensions/multi_core.py#L622" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_one_loop</code>(<strong><code>dls</code></strong>, <strong><code>rank</code></strong>, <strong><code>world_size</code></strong>, <strong><code>device</code></strong>, <strong><code>sync_valid</code></strong>, <strong><code>is_train</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Test-out-the-code">Test out the code<a class="anchor-link" href="#Test-out-the-code"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">fastai.metrics</span> <span class="kn">import</span> <span class="n">accuracy</span>
<span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span>

<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">first</span>
<span class="kn">from</span> <span class="nn">fastai.callback.schedule</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.test_utils</span> <span class="kn">import</span> <span class="n">VerboseCallback</span>
<span class="kn">from</span> <span class="nn">my_timesaver_utils.profiling</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">my_timesaver_utils.profiling_callback</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_torch_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_torch_model&#39;</span><span class="p">)</span>
    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">IS_PROFILING</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span>
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>

    <span class="c1"># Get loss function, optimizer, and model</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dset_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name2</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dataloader_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
    <span class="n">dls</span> <span class="o">=</span> <span class="n">make_torch_dataloaders</span><span class="p">(</span><span class="o">*</span><span class="n">dsets</span><span class="p">,</span> 
                                  <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> 
                                  <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> 
                                  <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                                  <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
                                  <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">,</span>
                                 <span class="p">)</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># do_one_loop(dls,rank,world_size,device,sync_valid=SYNC_VALID, is_train=True)</span>
    <span class="c1"># do_one_loop(dls,rank,world_size,device,sync_valid=SYNC_VALID, is_train=False)</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span>
                      <span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">to_my_profile</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name3</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_run_fit&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">my_profile</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span> 
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;end_train_torch_model&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">clear_prof_data</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;start_train_model&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xla </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s1"> start train model&#39;</span><span class="p">)</span>

    <span class="c1"># Scale learning rate to num cores</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="n">SYNC_VALID</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span>
    <span class="n">IS_PROFILING</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span>
    <span class="c1"># Get loss function, optimizer, and model</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">moms</span> <span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>

    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_dataloader_build&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">make_fastai_dataloaders</span><span class="p">(</span>
                            <span class="n">DATA</span><span class="p">,</span> 
                            <span class="n">PATH</span><span class="p">,</span> 
                            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> 
                            <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span> 
                            <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">,</span>
                            <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;build learner&#39;</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> 
                      <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                      <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                      <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                      <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                      <span class="n">moms</span><span class="o">=</span><span class="n">moms</span><span class="p">)</span>
                      
    <span class="n">learner</span><span class="o">.</span><span class="n">to_xla</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">(),</span> <span class="n">sync_valid</span><span class="o">=</span><span class="n">SYNC_VALID</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">to_my_profile</span><span class="p">()</span>
                               
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">master_print</span><span class="p">(</span><span class="s1">&#39;start running fit&#39;</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">rec_name3</span> <span class="o">=</span> <span class="s1">&#39;rank&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_run_fit&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">start_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">end_record</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="n">print_prof_data</span><span class="p">(</span><span class="n">rec_name3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;finished </span><span class="si">{</span><span class="n">rec_name3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">learner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">my_profile</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>  
    <span class="n">xm</span><span class="o">.</span><span class="n">rendezvous</span><span class="p">(</span><span class="s1">&#39;end_train_model&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_PROFILING</span><span class="p">:</span>
        <span class="n">clear_prof_data</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Start training processes</span>
<span class="k">def</span> <span class="nf">_mp_fn</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mp_fn2</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">FLAGS</span>
    <span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span>
    <span class="n">train_torch_model</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastcore.transform</span> <span class="kn">import</span> <span class="n">DisplayedTransform</span><span class="p">,</span> <span class="n">Transform</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">store_attr</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span><span class="p">,</span> <span class="n">PILBase</span><span class="p">,</span> <span class="n">image2tensor</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">TransformBlock</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_c</span>
<span class="c1"># from fastai.vision.all import *</span>
<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">DataBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span>
<span class="kn">from</span> <span class="nn">fastai.vision.data</span> <span class="kn">import</span> <span class="n">ImageBlock</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">parent_label</span><span class="p">,</span> <span class="n">GrandparentSplitter</span>
<span class="kn">from</span> <span class="nn">fastai.vision.augment</span> <span class="kn">import</span> <span class="n">Resize</span><span class="p">,</span> <span class="n">aug_transforms</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">imagenet_stats</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LOSS_FUNC</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">OPT_FUNC</span> <span class="o">=</span> <span class="n">Adam</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RandomSplitter</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.learner</span> <span class="kn">import</span> <span class="n">create_cnn_model</span>
<span class="kn">from</span> <span class="nn">fastai.vision.models</span> <span class="kn">import</span> <span class="n">resnet34</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Define Parameters</span>
<span class="n">FLAGS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># FLAGS[&#39;batch_size&#39;] = 1024</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;sync_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;is_profiling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5e-3</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2e-4</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TPU_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
<span class="c1"># FLAGS[&#39;num_cores&#39;] = 1 </span>
<span class="n">ARCH</span> <span class="o">=</span> <span class="n">resnet34</span>
<span class="n">USE_DBLOCK</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">fastcore.xtras</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
<span class="c1"># PATH = untar_data(URLs.MNIST)</span>
<span class="c1"># PATH = untar_data(URLs.MNIST_TINY)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">USE_DBLOCK</span><span class="p">:</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(.+)_\d+.jpg$&#39;</span>
    <span class="n">fname_labeller</span> <span class="o">=</span> <span class="n">FileNamePatternLabeller</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">DATA</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span><span class="p">),</span>
        <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
        <span class="n">get_y</span><span class="o">=</span><span class="n">fname_labeller</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
        <span class="n">item_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Resize</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]),],</span>
        <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">CategoryMap</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fname_labeller</span><span class="p">))</span>
    <span class="n">N_OUT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">USE_DBLOCK</span><span class="p">:</span>
    <span class="n">imagenet_norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
        <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> 
        <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>

    <span class="n">cifar_norm</span> <span class="o">=</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
        <span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> 
        <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">))</span>

    <span class="n">image_size</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;image_size&#39;</span><span class="p">]</span>
    <span class="n">splitter</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(.+)_\d+.jpg$&#39;</span>
    <span class="n">fname_labeller</span> <span class="o">=</span> <span class="n">FileNamePatternLabeller</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>

    <span class="n">DSET_BUILDER</span> <span class="o">=</span> <span class="n">TorchDatasetBuilder</span><span class="p">(</span>
        <span class="n">PATH</span><span class="p">,</span> 
        <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
        <span class="n">x_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">image_size</span><span class="p">,</span><span class="n">image_size</span><span class="p">)),</span> <span class="n">thv</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">imagenet_norm</span><span class="p">],</span>
        <span class="n">y_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">fname_labeller</span><span class="p">,</span> <span class="n">VocabularyMapper</span><span class="p">(),],</span>
        <span class="n">x_type_tfms</span><span class="o">=</span><span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
    <span class="p">)</span> 
    <span class="n">start_record</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
    <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">PATH</span><span class="p">),</span><span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">end_record</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
    <span class="n">print_prof_data</span><span class="p">(</span><span class="s1">&#39;master_vocab_setup&#39;</span><span class="p">)</span>
    <span class="n">clear_prof_data</span><span class="p">()</span>
    <span class="n">N_OUT</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">y_tfms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>     
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Function master_vocab_setup called 1 times.
Execution time max: 0.062, average: 0.062
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">N_OUT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">N_OUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;N_OUT </span><span class="si">{</span><span class="n">N_OUT</span><span class="si">}</span><span class="s1"> should be &gt; 0&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_model</span> <span class="o">=</span> <span class="n">create_cnn_model</span><span class="p">(</span><span class="n">ARCH</span><span class="p">,</span> <span class="n">N_OUT</span><span class="p">,</span> 
                                <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">concat_pool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading: &#34;https://download.pytorch.org/models/resnet34-333f7ec4.pth&#34; to /root/.cache/torch/hub/checkpoints/resnet34-333f7ec4.pth
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Only instantiate model weights once in memory.</span>
<span class="n">WRAPPED_MODEL</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">custom_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">SERIAL_EXEC</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpSerialExecutor</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># !rm -f /content/models/stage-1.pth</span>
<span class="k">if</span> <span class="n">USE_DBLOCK</span><span class="p">:</span>
    <span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
            <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">,),</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_cores&#39;</span><span class="p">],</span>
            <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>build learner
start running fit
start fit
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.555156</td>
      <td>1.375484</td>
      <td>0.650391</td>
      <td>01:29</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.434286</td>
      <td>2.420624</td>
      <td>0.428711</td>
      <td>01:10</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.108692</td>
      <td>3.544115</td>
      <td>0.382812</td>
      <td>01:13</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.050459</td>
      <td>11.507419</td>
      <td>0.125977</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.061296</td>
      <td>3.644594</td>
      <td>0.295898</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.959348</td>
      <td>5.412362</td>
      <td>0.223633</td>
      <td>01:11</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.851175</td>
      <td>3.070796</td>
      <td>0.475586</td>
      <td>01:12</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.751327</td>
      <td>2.332491</td>
      <td>0.521484</td>
      <td>01:12</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.635038</td>
      <td>1.993912</td>
      <td>0.610352</td>
      <td>01:16</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.526323</td>
      <td>1.708632</td>
      <td>0.653320</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.436013</td>
      <td>1.352804</td>
      <td>0.691406</td>
      <td>01:13</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.357857</td>
      <td>1.266021</td>
      <td>0.695312</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.290456</td>
      <td>1.102302</td>
      <td>0.757812</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.234473</td>
      <td>0.659987</td>
      <td>0.828125</td>
      <td>01:13</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.189875</td>
      <td>0.587717</td>
      <td>0.841797</td>
      <td>01:14</td>
    </tr>
    <tr>
      <td>15</td>
      <td>0.152140</td>
      <td>0.553342</td>
      <td>0.853516</td>
      <td>01:15</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.122204</td>
      <td>0.546671</td>
      <td>0.859375</td>
      <td>01:20</td>
    </tr>
    <tr>
      <td>17</td>
      <td>0.097916</td>
      <td>0.531075</td>
      <td>0.863281</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>18</td>
      <td>0.078714</td>
      <td>0.526530</td>
      <td>0.864258</td>
      <td>01:17</td>
    </tr>
    <tr>
      <td>19</td>
      <td>0.064623</td>
      <td>0.518947</td>
      <td>0.867188</td>
      <td>01:14</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>fit  called 1 times. max: 1503.930 avg: 1503.930
   epoch  called 20 times. max: 89.579 avg: 74.982
      train  called 20 times. max: 70.016 avg: 60.582
         train_batch  called 220 times. max: 8.594 avg: 1.374
            train_pred  called 220 times. max: 7.631 avg: 0.669
            train_loss  called 220 times. max: 0.062 avg: 0.004
            train_backward  called 220 times. max: 0.337 avg: 0.034
            train_step  called 220 times. max: 1.488 avg: 0.603
            train_zero_grad  called 220 times. max: 0.165 avg: 0.062
      valid  called 20 times. max: 19.549 avg: 14.394
         valid_batch  called 40 times. max: 0.029 avg: 0.010
            valid_pred  called 40 times. max: 0.028 avg: 0.009
            valid_loss  called 40 times. max: 0.002 avg: 0.001
CPU times: user 309 ms, sys: 191 ms, total: 500 ms
Wall time: 25min 37s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">USE_DBLOCK</span><span class="p">:</span> <span class="n">DATA</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">USE_DBLOCK</span><span class="p">:</span>
    <span class="n">mdls</span> <span class="o">=</span> <span class="n">DATA</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">mdsets</span> <span class="o">=</span> <span class="n">DSET_BUILDER</span><span class="o">.</span><span class="n">get_datasets</span><span class="p">()</span>
    <span class="n">mdls</span> <span class="o">=</span> <span class="n">make_torch_dataloaders</span><span class="p">(</span><span class="o">*</span><span class="n">mdsets</span><span class="p">,</span>
                                  <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">world_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">bs</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span>
                                  <span class="n">num_workers</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;num_workers&#39;</span><span class="p">]</span>
                                  <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">mdls</span><span class="p">,</span> <span class="n">custom_model</span><span class="p">,</span> 
                    <span class="n">loss_func</span><span class="o">=</span><span class="n">LOSS_FUNC</span><span class="p">,</span> 
                    <span class="n">opt_func</span><span class="o">=</span><span class="n">OPT_FUNC</span><span class="p">,</span> 
                    <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> 
                    <span class="n">wd</span><span class="o">=</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">],</span>
                    <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span><span class="n">FLAGS</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]))</span>
<span class="n">mlearner</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7f7cfcfcdb70&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mlearner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">one_param</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_param</span><span class="p">(</span><span class="n">mlearner</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cpu&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">valid_metrics</span> <span class="o">=</span> <span class="n">mlearner</span><span class="o">.</span><span class="n">validate</span><span class="p">();</span><span class="nb">print</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0.5264326333999634, 0.8648098111152649]
CPU times: user 3min 23s, sys: 4.32 s, total: 3min 27s
Wall time: 3min 31s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># mlearner.model.to(master_device)</span>
<span class="c1"># mlearner.opt = None</span>
<span class="c1"># mlearner.create_opt()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># valid_metrics = mlearner.validate(); valid_metrics</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

